<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Pricing Table – BrickBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/style.css">

<style>
:root {
  --blue: #1B73E8;
  --bg: #F5F7FA;
  --card: #FFFFFF;
  --border: #E5E7EB;
  --text-muted: #6B7280;
  --shadow: 0 8px 30px rgba(0,0,0,0.06);
}

body {
  margin: 0;
  background: var(--bg);
  font-family: "Inter", sans-serif;
}

/* HEADER */
header {
  background: var(--card);
  padding: 18px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border);
}

nav a {
  margin-left: 20px;
  text-decoration: none;
  font-weight: 600;
  color: #000;
}
nav a:hover { color: var(--blue); }

.wrapper {
  max-width: 900px;
  margin: 30px auto;
  padding: 20px;
}

.card {
  background: var(--card);
  padding: 26px;
  border-radius: 18px;
  border: 1px solid var(--border);
  box-shadow: var(--shadow);
  margin-bottom: 24px;
}

.card-title {
  font-size: 24px;
  font-weight: 800;
  margin-bottom: 14px;
}

label {
  font-weight: 600;
  margin-bottom: 6px;
  display: block;
}

input, select {
  width: 100%;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid var(--border);
  margin-bottom: 14px;
}

.btn-primary {
  background: var(--blue);
  color: white;
  padding: 14px 20px;
  border-radius: 10px;
  font-weight: 700;
  border: none;
  cursor: pointer;
}
.btn-primary:hover { opacity: 0.9; }

.split-box {
  padding: 14px;
  background: #f0f4ff;
  border-radius: 12px;
  margin-top: 14px;
}
</style>
</head>

<body>

<header>
  <div class="logo">BrickBook</div>
  <nav>
    <a href="contractor-dashboard.html">Dashboard</a>
    <a href="approvals.html">Approvals</a>
    <a href="contractor-review.html">Review</a>
    <a href="contractor-add-squads.html">Add Squads</a>
    <a href="contractor-login.html">Logout</a>
  </nav>
</header>

<div class="wrapper">

  <div class="card">
    <div class="card-title">Create Pricing Profile</div>

    <label>Pricing Name</label>
    <input type="text" id="priceName" placeholder="E.g. Standard Rates">

    <label>Select Squad</label>
    <select id="pricingSquadSelect" onchange="loadSquadMembers()"></select>

    <div id="splitBox" class="split-box">
      <p style="color:var(--text-muted); margin:0;">Select a squad to load members...</p>
    </div>

    <label>Price Per Brickwork Unit (£)</label>
    <input type="number" id="priceRate" placeholder="Enter rate">

    <button class="btn-primary" onclick="savePricing()">Save Pricing</button>
  </div>

  <div class="card">
    <div class="card-title">Existing Pricing Profiles</div>
    <div id="pricingList"></div>
  </div>

</div>

<script>
/* LOAD SQUADS */
function loadSquadsForPricing() {
    let squadSelect = document.getElementById("pricingSquadSelect");
    squadSelect.innerHTML = "";

    let squads = JSON.parse(localStorage.getItem("contractor_squads")) || [];

    if (squads.length === 0) {
        squadSelect.innerHTML = `<option>No squads found</option>`;
        return;
    }

    squads.forEach(s => {
        squadSelect.innerHTML += `
            <option value="${s.squadId}">${s.squadName}</option>
        `;
    });

    loadSquadMembers();
}

/* LOAD MEMBERS FOR SPLITS */
function loadSquadMembers() {
    let squadId = document.getElementById("pricingSquadSelect").value;
    let squads = JSON.parse(localStorage.getItem("contractor_squads")) || [];
    let squad = squads.find(s => s.squadId === squadId);

    let splitBox = document.getElementById("splitBox");
    splitBox.innerHTML = "";

    if (!squad) {
        splitBox.innerHTML = `<p>No squad selected</p>`;
        return;
    }

    if (squad.members.length === 0) {
        splitBox.innerHTML = `<p style="color:var(--text-muted);">No squad members yet</p>`;
        return;
    }

    squad.members.forEach(email => {
        let user = JSON.parse(localStorage.getItem("squad_user_" + email));

        splitBox.innerHTML += `
            <div style="margin-bottom:10px;">
                <label>${user.name} (${email})</label>
                <input type="number" class="split-input" data-email="${email}" placeholder="Split %">
            </div>
        `;
    });
}

/* SAVE PRICING PROFILE */
function savePricing() {
    const name = document.getElementById("priceName").value.trim();
    const rate = document.getElementById("priceRate").value.trim();
    const squadId = document.getElementById("pricingSquadSelect").value;

    if (!name || !rate) {
        alert("Enter all pricing details.");
        return;
    }

    const splits = [];
    document.querySelectorAll(".split-input").forEach(input => {
        splits.push({
            email: input.dataset.email,
            percent: input.value ? parseFloat(input.value) : 0
        });
    });

    let pricingList = JSON.parse(localStorage.getItem("pricing_profiles") || "[]");

    pricingList.push({
        id: "pricing_" + Date.now(),
        name,
        rate,
        squadId,
        splits
    });

    localStorage.setItem("pricing_profiles", JSON.stringify(pricingList));

    alert("Pricing profile saved.");
    renderPricingList();
}

/* SHOW EXISTING PROFILES */
function renderPricingList() {
    let container = document.getElementById("pricingList");
    let pricingList = JSON.parse(localStorage.getItem("pricing_profiles") || "[]");
    let squads = JSON.parse(localStorage.getItem("contractor_squads") || "[]");

    container.innerHTML = "";

    if (pricingList.length === 0) {
        container.innerHTML = `<p style='color:var(--text-muted);'>No pricing profiles yet.</p>`;
        return;
    }

    pricingList.forEach(p => {
        let squad = squads.find(s => s.squadId === p.squadId);

        container.innerHTML += `
            <div style="padding:12px; border:1px solid var(--border); 
                        border-radius:10px; margin-bottom:10px;">
              <strong>${p.name}</strong><br>
              Rate: £${p.rate}<br>
              Squad: ${squad ? squad.squadName : "Unknown"}<br>
              Splits:
              <ul>
                ${p.splits
                  .map(s => `<li>${s.email} — ${s.percent}%</li>`)
                  .join("")}
              </ul>
            </div>
        `;
    });
}

/* INIT */
loadSquadsForPricing();
renderPricingList();
</script>

</body>
</html>
