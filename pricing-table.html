<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pricing Manager – BrickBook</title>

<style>
:root {
  --blue: #1B73E8;
  --charcoal: #1F2933;
  --bg: #F5F7FA;
  --card-bg: #FFFFFF;
  --text-main: #1F2933;
  --text-muted: #6B7280;
  --border-subtle: #E5E7EB;
  --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.08);
  --accent: #10B981;
  --danger: #EF4444;
  --chip-bg: #E5F0FF;
  --chip-text: #1B3A57;
}

/* DARK MODE OVERRIDES */
body.dark {
  --bg: #050816;
  --card-bg: #0B1220;
  --text-main: #E5E7EB;
  --text-muted: #9CA3AF;
  --border-subtle: #1F2933;
  --shadow-soft: 0 18px 45px rgba(0,0,0,0.6);
  --chip-bg: #111827;
  --chip-text: #E5E7EB;
}

/* GLOBAL */
* { box-sizing: border-box; margin:0; padding:0; }
body {
  font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
  background: radial-gradient(circle at top, rgba(37,99,235,0.12), transparent 50%), var(--bg);
  color: var(--text-main);
}

/* HEADER */
header {
  background: rgba(255,255,255,0.9);
  backdrop-filter: blur(10px);
  padding: 16px 24px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border-bottom: 1px solid var(--border-subtle);
  position: sticky;
  top: 0;
  z-index: 100;
}
body.dark header {
  background: rgba(15,23,42,0.92);
}

.logo {
  font-size: 22px;
  font-weight: 800;
}

nav {
  display: flex;
  gap: 18px;
  align-items: center;
}
nav a {
  text-decoration: none;
  font-weight: 600;
  color: var(--text-main);
  font-size: 14px;
}
nav a:hover { color: var(--blue); }

/* DARK MODE TOGGLE */
.toggle-wrap {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--text-muted);
}
.toggle {
  width: 44px;
  height: 24px;
  border-radius: 999px;
  background: #D1D5DB;
  padding: 3px;
  display: flex;
  align-items: center;
  cursor: pointer;
  position: relative;
}
body.dark .toggle {
  background: #111827;
}
.toggle-thumb {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: #FFFFFF;
  box-shadow: 0 2px 6px rgba(0,0,0,0.35);
  transform: translateX(0);
  transition: transform 0.22s ease-out;
}
body.dark .toggle-thumb {
  transform: translateX(18px);
}

/* WRAPPER */
.wrapper {
  max-width: 1150px;
  margin: 0 auto;
  padding: 26px 18px 40px;
}

/* HERO HEADER CARD */
.hero-card {
  background: radial-gradient(circle at top left, rgba(59,130,246,0.28), transparent 55%), var(--card-bg);
  border-radius: 20px;
  padding: 20px 22px;
  box-shadow: var(--shadow-soft);
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  border: 1px solid rgba(148,163,184,0.3);
}
.hero-text h1 {
  font-size: 24px;
  font-weight: 800;
  margin-bottom: 6px;
}
.hero-text p {
  font-size: 14px;
  color: var(--text-muted);
}
.hero-pill {
  font-size: 12px;
  padding: 6px 12px;
  border-radius: 999px;
  background: rgba(16,185,129,0.12);
  color: #22C55E;
  font-weight: 600;
}

/* GRID LAYOUT */
.grid {
  display: grid;
  grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
  gap: 18px;
}

/* CARDS */
.card {
  background: var(--card-bg);
  border-radius: 18px;
  padding: 18px 18px 16px;
  box-shadow: var(--shadow-soft);
  border: 1px solid var(--border-subtle);
}
.card-title {
  font-size: 15px;
  font-weight: 700;
  margin-bottom: 6px;
}
.card-sub {
  font-size: 12px;
  color: var(--text-muted);
  margin-bottom: 12px;
}

/* INPUTS / SELECTS */
label {
  font-size: 12px;
  font-weight: 600;
  display: block;
  margin-bottom: 4px;
}
input[type="text"],
input[type="number"],
select {
  width: 100%;
  padding: 8px 9px;
  border-radius: 10px;
  border: 1px solid var(--border-subtle);
  background: transparent;
  color: var(--text-main);
  font-size: 13px;
  margin-bottom: 10px;
}
input::placeholder { color: #9CA3AF; }
body.dark input[type="text"],
body.dark input[type="number"],
body.dark select {
  background: #020617;
}

/* CHIPS */
.chip-row {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 8px;
}
.chip {
  padding: 4px 10px;
  border-radius: 999px;
  font-size: 11px;
  background: var(--chip-bg);
  color: var(--chip-text);
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* FIELDS TABLE */
.field-table {
  width: 100%;
  border-collapse: collapse;
  margin-bottom: 8px;
}
.field-table th,
.field-table td {
  padding: 6px;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 12px;
}
.field-table th {
  text-align: left;
  font-weight: 600;
  color: var(--text-muted);
}
.field-table input[type="text"],
.field-table input[type="number"] {
  margin-bottom: 0;
}

/* BUTTONS */
.btn {
  border-radius: 999px;
  font-size: 13px;
  font-weight: 600;
  border: none;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 6px;
}
.btn-sm {
  padding: 6px 11px;
}
.btn-md {
  padding: 9px 16px;
}
.btn-primary {
  background: linear-gradient(120deg, var(--blue), #2563EB);
  color: #FFFFFF;
  box-shadow: 0 8px 18px rgba(37,99,235,0.35);
}
.btn-ghost {
  background: transparent;
  color: var(--text-muted);
}
.btn-danger {
  background: rgba(239,68,68,0.1);
  color: var(--danger);
}

/* PROFILES TABLE */
.profiles-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}
.profiles-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 6px;
}
.profiles-table th,
.profiles-table td {
  padding: 8px 6px;
  border-bottom: 1px solid var(--border-subtle);
  font-size: 12px;
}
.profiles-table th {
  text-align: left;
  color: var(--text-muted);
}
.tag {
  font-size: 11px;
  padding: 3px 8px;
  border-radius: 999px;
  background: rgba(37,99,235,0.08);
  color: var(--blue);
}

@media(max-width: 900px) {
  .grid { grid-template-columns: minmax(0,1fr); }
  .hero-card { flex-direction: column; align-items: flex-start; gap: 10px; }
}

@media(max-width: 640px) {
  header { padding: 14px 16px; }
  .wrapper { padding: 20px 14px 30px; }
  .hero-card { padding: 16px 14px; }
}
</style>
</head>
<body>

<script>
// Contractor login guard (same as other contractor pages)
if (!sessionStorage.getItem("loggedIn")) {
  window.location.href = "contractor-login.html";
}
function logout() {
  sessionStorage.removeItem("loggedIn");
  window.location.href = "contractor-login.html";
}
</script>

<header>
  <div class="logo">BrickBook</div>
  <nav>
    <a href="contractor-dashboard.html">Dashboard</a>
    <a href="approvals.html">Approvals</a>
    <a href="contractor-review.html">Review</a>
    <a href="pricing-table.html">Pricing</a>
    <a href="contractor-add-squads.html">Add Squads</a>
    <div class="toggle-wrap">
      <span>Dark mode</span>
      <div class="toggle" onclick="toggleDarkMode()">
        <div class="toggle-thumb"></div>
      </div>
    </div>
    <a href="#" onclick="logout()">Logout</a>
  </nav>
</header>

<div class="wrapper">

  <!-- HEADER CARD -->
  <div class="hero-card">
    <div class="hero-text">
      <h1>Pricing Manager</h1>
      <p>Set custom rates by squad & site. Add any measurements you like – bricks, insulation, dpc, you name it.</p>
    </div>
    <div class="hero-pill">
      Local-only for now · Backend-ready
    </div>
  </div>

  <div class="grid">
    <!-- LEFT: SETUP FORM -->
    <div class="card">
      <div class="card-title">Squads & Sites</div>
      <div class="card-sub">Choose an active squad from your Manage Squads page, then link it to a pricing profile.</div>

      <!-- Squads (from Manage Squads) -->
      <div style="margin-bottom:10px;">
        <label for="squad-select">Squad (from active squads)</label>
        <div style="display:flex; gap:6px; margin-bottom:6px;">
          <select id="squad-select" style="flex:1;">
            <option value="">Select squad…</option>
          </select>
          <a href="contractor-add-squads.html" class="btn btn-sm btn-ghost" style="text-decoration:none;">
            Manage
          </a>
        </div>
        <div class="chip-row" id="squad-chips"></div>
      </div>

      <!-- Sites -->
      <div style="margin-bottom:14px; margin-top:4px;">
        <label for="new-site">Add Site</label>
        <div style="display:flex; gap:6px; margin-bottom:6px;">
          <input type="text" id="new-site" placeholder="e.g. Plot 12-30, Greenfield Estate">
          <button class="btn btn-sm btn-primary" type="button" onclick="addSite()">+ Add</button>
        </div>
        <div class="chip-row" id="site-chips"></div>
      </div>

      <hr style="border:none; border-top:1px solid var(--border-subtle); margin:10px 0 12px;">

      <!-- Choose Site for this pricing profile -->
      <div style="display:grid; grid-template-columns:1fr; gap:10px;">
        <div>
          <label for="site-select">Site</label>
          <select id="site-select">
            <option value="">Select site…</option>
          </select>
        </div>
      </div>

      <div class="card-sub" style="margin-top:10px;">
        Now define the measurements & rates for this squad + site.
      </div>

      <!-- CUSTOM FIELDS TABLE -->
      <table class="field-table" id="fields-table">
        <thead>
          <tr>
            <th style="width:45%;">Measurement</th>
            <th style="width:25%;">Unit (note)</th>
            <th style="width:20%;">Rate (£)</th>
            <th style="width:10%;"></th>
          </tr>
        </thead>
        <tbody id="fields-body">
          <!-- rows added by JS -->
        </tbody>
      </table>

      <button class="btn btn-sm btn-ghost" type="button" onclick="addFieldRow()">
        + Add measurement
      </button>

      <div style="display:flex; justify-content:flex-end; gap:8px; margin-top:14px;">
        <button class="btn btn-md btn-ghost" type="button" onclick="clearForm()">Clear</button>
        <button class="btn btn-md btn-primary" type="button" onclick="saveProfile()">Save Pricing</button>
      </div>
    </div>

    <!-- RIGHT: ACTIVE PROFILES -->
    <div class="card">
      <div class="profiles-header">
        <div>
          <div class="card-title">Active Pricing Profiles</div>
          <div class="card-sub">One row per squad + site. Click edit to update rates.</div>
        </div>
      </div>

      <table class="profiles-table">
        <thead>
          <tr>
            <th>Squad</th>
            <th>Site</th>
            <th>Fields</th>
            <th>Updated</th>
            <th></th>
          </tr>
        </thead>
        <tbody id="profiles-body">
          <!-- populated by JS -->
        </tbody>
      </table>
    </div>
  </div>
</div>

<script>
// ---------- THEME (DARK MODE) ----------
const THEME_KEY = "brickbook_theme";
function applyTheme(theme) {
  if (theme === "dark") {
    document.body.classList.add("dark");
  } else {
    document.body.classList.remove("dark");
  }
}
function toggleDarkMode() {
  const isDark = document.body.classList.contains("dark");
  const next = isDark ? "light" : "dark";
  applyTheme(next);
  localStorage.setItem(THEME_KEY, next);
}
(function initTheme() {
  const saved = localStorage.getItem(THEME_KEY) || "light";
  applyTheme(saved);
})();

// ---------- STATE & STORAGE ----------
const STORAGE_KEY = "brickbook_pricing_state";

let state = {
  squads: [], // kept for backwards compatibility, but not used for adding now
  sites: [],
  profiles: [] // { id, squad, site, fields:[{name,unit,rate}], updatedAt }
};

function loadState() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    if (parsed && typeof parsed === "object") {
      state = Object.assign(state, parsed);
    }
  } catch (e) {
    console.error("Failed to parse pricing state", e);
  }
}

function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}

// ---------- SITES ----------
function addSite() {
  const input = document.getElementById("new-site");
  const name = input.value.trim();
  if (!name) return;
  if (!state.sites.includes(name)) {
    state.sites.push(name);
    saveState();
    renderSites();
  }
  input.value = "";
}

function removeSite(name) {
  state.sites = state.sites.filter(s => s !== name);
  state.profiles = state.profiles.filter(p => p.site !== name);
  saveState();
  renderSites();
  renderProfiles();
}

function renderSites() {
  const chips = document.getElementById("site-chips");
  const select = document.getElementById("site-select");
  chips.innerHTML = "";
  select.innerHTML = `<option value="">Select site…</option>`;

  state.sites.forEach(name => {
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${name}</span>
      <span style="font-size:11px; opacity:0.7; cursor:pointer;" onclick="removeSite('${name.replace(/'/g,"\\'")}')">×</span>
    `;
    chips.appendChild(chip);

    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });
}

// ---------- SQUADS (FROM MANAGE SQUADS) ----------
function renderSquads() {
  const chips = document.getElementById("squad-chips");
  const select = document.getElementById("squad-select");
  if (!chips || !select) return;

  chips.innerHTML = "";
  select.innerHTML = `<option value="">Select squad…</option>`;

  const managerSquads = JSON.parse(localStorage.getItem("contractor_squads")) || [];

  managerSquads.forEach(s => {
    const name = s.squadName || s.squadId || "Squad";
    const memberCount = (s.members && s.members.length) || 0;

    // Chip showing squad + member count
    const chip = document.createElement("div");
    chip.className = "chip";
    chip.innerHTML = `
      <span>${name}</span>
      <span style="font-size:10px; opacity:0.7;">${memberCount} member${memberCount === 1 ? "" : "s"}</span>
    `;
    chips.appendChild(chip);

    // Option in select
    const opt = document.createElement("option");
    opt.value = name;        // store by name for now (matches old pricing behaviour)
    opt.textContent = name;
    select.appendChild(opt);
  });
}

// ---------- FIELDS (CUSTOM MEASUREMENTS) ----------
function addFieldRow(field = { name: "", unit: "", rate: "" }) {
  const tbody = document.getElementById("fields-body");
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td><input type="text" placeholder="e.g. Bricks" value="${field.name || ""}"></td>
    <td><input type="text" placeholder="e.g. £/1000" value="${field.unit || ""}"></td>
    <td><input type="number" placeholder="0.00" step="0.01" value="${field.rate || ""}"></td>
    <td style="text-align:center;">
      <button class="btn btn-sm btn-danger" type="button" onclick="removeFieldRow(this)">×</button>
    </td>
  `;
  tbody.appendChild(tr);
}

function removeFieldRow(btn) {
  const tr = btn.closest("tr");
  tr?.remove();
}

function getFieldsFromForm() {
  const rows = document.querySelectorAll("#fields-body tr");
  const fields = [];
  rows.forEach(tr => {
    const inputs = tr.querySelectorAll("input");
    const name = inputs[0].value.trim();
    const unit = inputs[1].value.trim();
    const rate = parseFloat(inputs[2].value);
    if (!name || isNaN(rate)) return;
    fields.push({ name, unit, rate });
  });
  return fields;
}

function setFieldsInForm(fields) {
  const tbody = document.getElementById("fields-body");
  tbody.innerHTML = "";
  if (!fields || !fields.length) {
    addFieldRow();
  } else {
    fields.forEach(f => addFieldRow(f));
  }
}

// ---------- PROFILES ----------
let editingProfileId = null;

function saveProfile() {
  const squad = document.getElementById("squad-select").value;
  const site = document.getElementById("site-select").value;
  const fields = getFieldsFromForm();

  if (!squad || !site) {
    alert("Select a squad and a site before saving.");
    return;
  }
  if (!fields.length) {
    alert("Add at least one measurement and rate.");
    return;
  }

  const now = new Date().toISOString();

  if (editingProfileId) {
    // Update existing
    const idx = state.profiles.findIndex(p => p.id === editingProfileId);
    if (idx !== -1) {
      state.profiles[idx] = { ...state.profiles[idx], squad, site, fields, updatedAt: now };
    }
  } else {
    // Either update matching squad+site, or create new
    let existing = state.profiles.find(p => p.squad === squad && p.site === site);
    if (existing) {
      existing.fields = fields;
      existing.updatedAt = now;
    } else {
      state.profiles.push({
        id: "p_" + Date.now(),
        squad,
        site,
        fields,
        updatedAt: now
      });
    }
  }

  saveState();
  renderProfiles();
  editingProfileId = null;
  alert("Pricing saved for " + squad + " @ " + site);
}

function renderProfiles() {
  const tbody = document.getElementById("profiles-body");
  tbody.innerHTML = "";

  if (!state.profiles.length) {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td colspan="5" style="font-size:12px; color:var(--text-muted); padding:12px 6px;">
      No pricing profiles yet. Select a squad & site, define measurements, then click Save.
    </td>`;
    tbody.appendChild(tr);
    return;
  }

  state.profiles.forEach(p => {
    const tr = document.createElement("tr");

    const dateStr = p.updatedAt
      ? new Date(p.updatedAt).toLocaleDateString(undefined, { day:"2-digit", month:"short", year:"numeric" })
      : "-";

    tr.innerHTML = `
      <td>${p.squad}</td>
      <td>${p.site}</td>
      <td><span class="tag">${p.fields.length} fields</span></td>
      <td>${dateStr}</td>
      <td style="text-align:right;">
        <button class="btn btn-sm btn-ghost" type="button" onclick="editProfile('${p.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" type="button" onclick="deleteProfile('${p.id}')">Del</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function editProfile(id) {
  const p = state.profiles.find(x => x.id === id);
  if (!p) return;
  editingProfileId = id;

  document.getElementById("squad-select").value = p.squad;
  document.getElementById("site-select").value = p.site;
  setFieldsInForm(p.fields);
}

function deleteProfile(id) {
  if (!confirm("Delete this pricing profile?")) return;
  state.profiles = state.profiles.filter(p => p.id !== id);
  saveState();
  renderProfiles();
  if (editingProfileId === id) {
    clearForm();
  }
}

function clearForm() {
  editingProfileId = null;
  document.getElementById("squad-select").value = "";
  document.getElementById("site-select").value = "";
  setFieldsInForm([]);
}

// ---------- INIT ----------
(function init() {
  loadState();
  renderSquads();   // now reads from contractor_squads
  renderSites();
  renderProfiles();
  if (!document.querySelector("#fields-body tr")) {
    addFieldRow();
  }
})();
</script>

</body>
</html>
