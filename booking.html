<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Booking-Off – BrickBook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Global styles -->
  <link rel="stylesheet" href="assets/style.css" />

  <!-- Firebase config (uses firebase.js you already have) -->
  <script type="module" src="./firebase.js"></script>

  <style>
    .plot-card-header {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      align-items: center;
      margin-bottom: 10px;
    }

    .plot-card-header .plot-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    .plot-card-totals {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 10px;
      font-size: 13px;
    }

    .plot-card-totals div span.value {
      font-weight: 700;
      font-size: 15px;
      margin-left: 4px;
    }

    .grand-totals-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: flex-end;
      font-size: 14px;
      margin-top: 10px;
    }

    .grand-totals-row div span.value {
      font-weight: 800;
      font-size: 18px;
      margin-left: 4px;
    }

    .split-row {
      display: grid;
      grid-template-columns: 1.4fr 0.6fr 1fr 1fr;
      gap: 8px;
      margin-bottom: 8px;
    }

    @media (max-width: 640px) {
      .split-row {
        grid-template-columns: 1.4fr 0.6fr 1fr 1fr;
      }
    }
  </style>
</head>

<body class="page" data-page="booking">

<script>
// --- LOGIN GUARD (squad, existing logic) ---
let squadUser = sessionStorage.getItem("squadUser");
if (!squadUser) {
  const backup = localStorage.getItem("lastSquadUser");
  if (backup) {
    sessionStorage.setItem("squadUser", backup);
    squadUser = backup;
  } else {
    window.location.href = "squad-login.html";
  }
}
localStorage.setItem("lastSquadUser", squadUser);
</script>

<!-- HEADER -->
<header class="site-header">
  <div class="header-inner">
    <div class="logo">BrickBook</div>
    <nav class="nav">
      <a href="booking.html" class="active">Booking-Off</a>
      <a href="squad-dashboard.html">Dashboard</a>
      <a href="squad-history.html">History</a>
      <a href="squad-profile.html">Profile</a>
      <a href="#" onclick="logout()">Logout</a>
    </nav>
    <div class="hamburger" onclick="toggleMenu()">☰</div>
  </div>
</header>

<!-- MOBILE NAV -->
<div id="mobileMenu" class="mobile-nav">
  <a href="booking.html">Booking-Off</a>
  <a href="squad-dashboard.html">Dashboard</a>
  <a href="squad-history.html">History</a>
  <a href="squad-profile.html">Profile</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<main class="container">

  <!-- HERO -->
  <section class="hero-card" style="margin-top:12px;">
    <div class="hero-header" style="flex-direction:column; gap:8px;">
      <div>
        <h1 class="h1" style="font-size:22px; margin-bottom:4px;">
          Booking-Off
        </h1>
        <p class="hero-sub">
          Choose your squad & site, then book off plots with labour + materials.
          Materials are recorded only – they don’t affect wages.
        </p>
      </div>
    </div>
  </section>

  <!-- SQUAD + SITE -->
  <section class="card mt-16">
    <div class="card-title">Squad & Site</div>
    <div class="card-sub">Rates and materials load from the Pricing Manager.</div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:10px;">
      <div>
        <label>Squad</label>
        <select id="select-squad">
          <option value="">Select Squad…</option>
        </select>
      </div>
      <div>
        <label>Site</label>
        <select id="select-site">
          <option value="">Select Site…</option>
        </select>
      </div>
    </div>

    <div class="mt-12 text-muted" style="font-size:13px;">
      Choose a squad + site, then add plots below. Fields & rates come from your contractor’s pricing profiles.
    </div>
  </section>

  <!-- PLOTS AREA -->
  <section class="card mt-16">
    <div class="card-header-row">
      <div>
        <div class="card-title">Plots</div>
        <div class="card-sub">Add each plot booked off this session.</div>
      </div>
      <button class="btn btn-sm btn-ghost" type="button" onclick="addPlot()">
        + Add plot
      </button>
    </div>

    <div id="plots-container" class="mt-12"></div>

    <div class="grand-totals-row">
      <div>
        Labour total:
        £<span class="value" id="grand-labour-total">0.00</span>
      </div>
      <div>
        Materials total:
        £<span class="value" id="grand-materials-total">0.00</span>
      </div>
    </div>
  </section>

  <!-- SQUAD SPLIT -->
  <section class="card mt-16">
    <div class="card-title">Squad Split (optional)</div>
    <div class="card-sub">
      Use this to work out wages per person. This doesn’t change the contractor totals – it’s for your squad only.
    </div>

    <div class="split-row mt-12" style="font-weight:700; font-size:13px;">
      <div>Name</div>
      <div>%</div>
      <div>Wages (£)</div>
      <div>After CIS</div>
    </div>

    <div id="split-container"></div>

    <div class="row row-wrap row-justify-end mt-12">
      <button class="btn btn-sm btn-ghost" type="button" onclick="addSplitRow()">+ Add person</button>
    </div>

    <div class="grand-totals-row">
      <div>
        Total after CIS (from split):
        £<span class="value" id="split-total-cis">0.00</span>
      </div>
    </div>
  </section>

  <!-- SUBMIT -->
  <section class="card mt-16">
    <div class="card-title">Submit booking-off</div>
    <div class="card-sub">
      Checks will be done by your contractor. You’ll see the status under Dashboard & History.
    </div>

    <div class="row row-wrap mt-16">
      <button class="btn btn-primary" type="button" onclick="submitBooking()">
        Submit Booking-Off
      </button>
    </div>
  </section>

</main>

<footer class="site-footer">
  <div class="footer-inner">
    <span>© 2025 BrickBook</span>
    <span class="text-muted">Booking-Off</span>
  </div>
</footer>

<script src="assets/main.js"></script>

<!-- ALL PAGE LOGIC (LOCAL + FIRESTORE) -->
<script type="module">
  import { db } from "./firebase.js";
  import {
    collection,
    addDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // For now, send all bookings to THIS contractor account.
  // Later we can make this dynamic per-squad.
  const CONTRACTOR_ID = "YXpFCmpxoXczJ6Krgi1ijeVrmX53";

  // ---- HEADER / NAV ----
  window.toggleMenu = function () {
    document.getElementById("mobileMenu").classList.toggle("show");
  };

  window.logout = function () {
    sessionStorage.removeItem("squadUser");
    window.location.href = "squad-login.html";
  };

  // ---- PRICING MANAGER DATA ----
  const PRICING_KEY = "brickbook_pricing_state";
  let pricing = { squads: [], sites: [], profiles: [] };

  try {
    const stored = localStorage.getItem(PRICING_KEY);
    if (stored) {
      const parsed = JSON.parse(stored);
      if (parsed && typeof parsed === "object") {
        pricing = Object.assign(pricing, parsed);
      }
    }
  } catch (e) {
    console.error("Error parsing pricing state", e);
  }

  const squadSelect = document.getElementById("select-squad");
  const siteSelect = document.getElementById("select-site");

  pricing.squads.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    squadSelect.appendChild(opt);
  });
  pricing.sites.forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    siteSelect.appendChild(opt);
  });

  function getActiveProfileFields() {
    const s = squadSelect.value;
    const t = siteSelect.value;
    if (!s || !t) return [];
    const profile = pricing.profiles.find(p => p.squad === s && p.site === t);
    return profile ? (profile.fields || []) : [];
  }

  function splitLabourAndMaterials(fields) {
    const labour = [];
    const materials = [];
    fields.forEach(f => {
      const name = (f.name || "").toLowerCase();
      if (/brick|block|insulation|dpc|tie|lintel|sand|cement|mortar|stone/.test(name)) {
        materials.push(f);
      } else {
        labour.push(f);
      }
    });
    return { labour, materials };
  }

  // ---- PLOTS ----
  const plotsContainer = document.getElementById("plots-container");

  window.addPlot = function () {
    const allFields = getActiveProfileFields();
    if (!allFields.length) {
      alert("Pick a squad and site that has a pricing profile set up.");
      return;
    }

    const { labour, materials } = splitLabourAndMaterials(allFields);

    const plotId = "plot-" + Date.now();
    const card = document.createElement("div");
    card.className = "card plot-card";
    card.dataset.plotId = plotId;

    const labourRowsHtml = labour.map(f => `
      <tr class="labour-row" data-name="${f.name || ""}">
        <td>${f.name || ""}</td>
        <td><input type="number" class="qty input-labour" min="0" step="0.01" oninput="updatePlotTotals(this)"></td>
        <td><input type="number" class="rate" value="${f.rate ?? ""}" step="0.01" readonly></td>
        <td>£<span class="row-total-labour">0.00</span></td>
      </tr>
    `).join("");

    const materialsRowsHtml = materials.map(f => `
      <tr class="material-row" data-name="${f.name || ""}" data-unit="${f.unit || ""}">
        <td>${f.name || ""}</td>
        <td><input type="number" class="mat-qty" min="0" step="0.01" oninput="updatePlotTotals(this)"></td>
        <td>${f.unit || ""}</td>
        <td><input type="number" class="mat-rate" value="${f.rate ?? ""}" step="0.01" readonly></td>
        <td>£<span class="row-total-material">0.00</span></td>
      </tr>
    `).join("");

    card.innerHTML = `
      <div class="plot-card-header">
        <div class="plot-label">
          Plot
          <input type="text" class="plot-number" placeholder="e.g. 24A" style="max-width:120px;">
        </div>
        <button class="btn btn-sm btn-danger" type="button" onclick="removePlot(this)">Remove</button>
      </div>

      <div class="card-sub" style="margin-bottom:8px;">
        Fill in labour done and any materials used on this plot.
      </div>

      <div class="mt-8">
        <div class="card-title" style="font-size:14px;">Labour</div>
        <table class="table mt-8">
          <thead>
            <tr>
              <th>Measurement</th>
              <th style="width:90px;">Qty</th>
              <th style="width:80px;">Rate (£)</th>
              <th style="width:100px;">Total (£)</th>
            </tr>
          </thead>
          <tbody>
            ${labourRowsHtml || `
              <tr><td colspan="4" class="text-muted" style="font-size:13px;">No labour fields for this profile.</td></tr>
            `}
          </tbody>
        </table>
      </div>

      <div class="mt-16">
        <div class="card-title" style="font-size:14px;">Materials</div>
        <div class="card-sub">Tracked only – not added into wages.</div>
        <table class="table mt-8">
          <thead>
            <tr>
              <th>Material</th>
              <th style="width:90px;">Qty</th>
              <th style="width:70px;">Unit</th>
              <th style="width:80px;">Rate (£)</th>
              <th style="width:100px;">Total (£)</th>
            </tr>
          </thead>
          <tbody>
            ${materialsRowsHtml || `
              <tr><td colspan="5" class="text-muted" style="font-size:13px;">No materials set in pricing for this profile.</td></tr>
            `}
          </tbody>
        </table>
      </div>

      <div class="mt-12">
        <label>Notes</label>
        <textarea class="plot-notes" placeholder="Optional site notes for this plot..."></textarea>
      </div>

      <div class="plot-card-totals">
        <div>Labour total: £<span class="value plot-labour-total">0.00</span></div>
        <div>Materials total: £<span class="value plot-materials-total">0.00</span></div>
      </div>
    `;

    plotsContainer.appendChild(card);
  };

  window.removePlot = function (btn) {
    const card = btn.closest(".plot-card");
    card?.remove();
    updateGrandTotals();
    updateSplitTotals();
  };

  window.updatePlotTotals = function (el) {
    const card = el.closest(".plot-card");
    if (!card) return;

    let labourTotal = 0;
    card.querySelectorAll("tr.labour-row").forEach(tr => {
      const qty = parseFloat(tr.querySelector(".qty")?.value) || 0;
      const rate = parseFloat(tr.querySelector(".rate")?.value) || 0;
      const rowTotal = qty * rate;
      labourTotal += rowTotal;
      const span = tr.querySelector(".row-total-labour");
      if (span) span.textContent = rowTotal.toFixed(2);
    });

    let materialsTotal = 0;
    card.querySelectorAll("tr.material-row").forEach(tr => {
      const qty = parseFloat(tr.querySelector(".mat-qty")?.value) || 0;
      const rate = parseFloat(tr.querySelector(".mat-rate")?.value) || 0;
      const rowTotal = qty * rate;
      materialsTotal += rowTotal;
      const span = tr.querySelector(".row-total-material");
      if (span) span.textContent = rowTotal.toFixed(2);
    });

    const labourSpan = card.querySelector(".plot-labour-total");
    const materialsSpan = card.querySelector(".plot-materials-total");
    if (labourSpan) labourSpan.textContent = labourTotal.toFixed(2);
    if (materialsSpan) materialsSpan.textContent = materialsTotal.toFixed(2);

    updateGrandTotals();
    updateSplitTotals();
  };

  function updateGrandTotals() {
    let grandLabour = 0;
    let grandMaterials = 0;
    document.querySelectorAll(".plot-labour-total").forEach(s => {
      grandLabour += parseFloat(s.textContent) || 0;
    });
    document.querySelectorAll(".plot-materials-total").forEach(s => {
      grandMaterials += parseFloat(s.textContent) || 0;
    });

    document.getElementById("grand-labour-total").textContent = grandLabour.toFixed(2);
    document.getElementById("grand-materials-total").textContent = grandMaterials.toFixed(2);
  }

  // ---- SQUAD SPLIT ----
  const splitContainer = document.getElementById("split-container");

  window.addSplitRow = function () {
    const row = document.createElement("div");
    row.className = "split-row";
    row.innerHTML = `
      <input type="text" class="split-name" placeholder="Name">
      <input type="number" class="split-percent" min="0" max="100" step="0.1" oninput="onSplitPercentChange(this)">
      <input type="number" class="split-wages" step="0.01" oninput="onSplitWagesChange(this)">
      <input type="number" class="split-aftercis" step="0.01" readonly>
    `;
    splitContainer.appendChild(row);
  };

  // start with 3 default rows
  addSplitRow();
  addSplitRow();
  addSplitRow();

  window.onSplitPercentChange = function (el) {
    const row = el.closest(".split-row");
    if (!row) return;

    const pct = parseFloat(el.value) || 0;
    const grandLabour = parseFloat(document.getElementById("grand-labour-total").textContent) || 0;
    const wages = grandLabour * (pct / 100);

    row.querySelector(".split-wages").value = wages.toFixed(2);
    row.querySelector(".split-aftercis").value = (wages * 0.8).toFixed(2);

    updateSplitTotals();
  };

  window.onSplitWagesChange = function (el) {
    const row = el.closest(".split-row");
    if (!row) return;
    const wages = parseFloat(el.value) || 0;
    const grandLabour = parseFloat(document.getElementById("grand-labour-total").textContent) || 0;

    if (grandLabour > 0) {
      const pct = (wages / grandLabour) * 100;
      row.querySelector(".split-percent").value = pct.toFixed(1);
    }
    row.querySelector(".split-aftercis").value = (wages * 0.8).toFixed(2);
    updateSplitTotals();
  };

  function updateSplitTotals() {
    let totalCIS = 0;
    document.querySelectorAll(".split-aftercis").forEach(input => {
      totalCIS += parseFloat(input.value) || 0;
    });
    document.getElementById("split-total-cis").textContent = totalCIS.toFixed(2);
  }

  // ---- SUBMIT BOOKING (LOCAL + FIRESTORE) ----
  window.submitBooking = async function () {
    const plots = document.querySelectorAll(".plot-card");
    if (!plots.length) {
      alert("Add at least one plot before submitting.");
      return;
    }

    const squadName = squadSelect.value;
    const siteName = siteSelect.value;
    if (!squadName || !siteName) {
      alert("Select a Squad and Site first.");
      return;
    }

    const grandLabour = parseFloat(document.getElementById("grand-labour-total").textContent) || 0;
    const grandMaterials = parseFloat(document.getElementById("grand-materials-total").textContent) || 0;

    if (grandLabour <= 0) {
      alert("Enter some labour quantities so the total is above £0.00.");
      return;
    }

    const today = new Date();
    const dateStr = today.toISOString().slice(0, 10);

    // Build plots array
    const plotsData = [];
    plots.forEach(card => {
      const plotNumber = card.querySelector(".plot-number")?.value.trim() || "";
      if (!plotNumber) return;

      const labourTotal = parseFloat(card.querySelector(".plot-labour-total")?.textContent) || 0;

      const labourRows = [];
      card.querySelectorAll("tr.labour-row").forEach(tr => {
        const name = tr.dataset.name || "";
        const qty = parseFloat(tr.querySelector(".qty")?.value) || 0;
        const rate = parseFloat(tr.querySelector(".rate")?.value) || 0;
        if (!qty) return;
        labourRows.push({
          measurement: name,
          qty,
          rate
        });
      });

      const materials = [];
      card.querySelectorAll("tr.material-row").forEach(tr => {
        const name = tr.dataset.name || "";
        const unit = tr.dataset.unit || "";
        const qty = parseFloat(tr.querySelector(".mat-qty")?.value) || 0;
        const rate = parseFloat(tr.querySelector(".mat-rate")?.value) || 0;
        if (!qty) return;
        materials.push({
          name,
          unit,
          qty,
          rate
        });
      });

      const notes = card.querySelector(".plot-notes")?.value.trim() || "";

      plotsData.push({
        plot: plotNumber,
        notes,
        rows: labourRows,
        materials,
        labourTotal
      });
    });

    if (!plotsData.length) {
      alert("Please enter at least one plot with a plot number.");
      return;
    }

    // Build split array
    const splitData = [];
    document.querySelectorAll(".split-row").forEach(row => {
      const name = row.querySelector(".split-name")?.value.trim();
      const percent = parseFloat(row.querySelector(".split-percent")?.value) || 0;
      if (name && percent > 0) {
        splitData.push({ name, percent });
      }
    });

    // --- EXISTING LOCAL STORAGE (for squad history) ---
    const squadUserKey = "squad_" + (sessionStorage.getItem("squadUser") || "");
    let localData;
    try {
      localData = JSON.parse(localStorage.getItem(squadUserKey) || "{}");
    } catch (e) {
      localData = {};
    }
    if (!localData.bookings) localData.bookings = [];
    if (!localData.earnings) localData.earnings = [];

    plotsData.forEach(p => {
      const afterCIS = p.labourTotal * 0.8;
      localData.bookings.push({
        date: dateStr,
        plot: p.plot,
        wage: p.labourTotal,
        afterCIS,
        status: "Pending",
        notes: p.notes,
        labourRows: p.rows,
        materials: p.materials
      });
    });

    if (grandLabour > 0) {
      localData.earnings.push({
        date: dateStr,
        afterCIS: grandLabour * 0.8
      });
    }

    localStorage.setItem(squadUserKey, JSON.stringify(localData));

    // --- FIRESTORE SUBMISSION (for contractor) ---
    try {
      const submission = {
        squad: squadName,
        site: siteName,
        status: "pending",
        submittedAt: serverTimestamp(),
        plots: plotsData.map(p => ({
          plot: p.plot,
          notes: p.notes,
          photos: [],    // you can wire photos later
          rows: p.rows
        })),
        split: splitData,
        grandTotal: grandLabour,
        materialsTotal: grandMaterials,
        createdBySquad: sessionStorage.getItem("squadUser") || null
      };

      await addDoc(
        collection(db, "contractors", CONTRACTOR_ID, "submissions"),
        submission
      );
    } catch (err) {
      console.error("Error saving to Firestore:", err);
      alert("Saved locally, but failed to send to contractor. Please let them know manually.");
    }

    alert("Booking-Off submitted. It will appear under Dashboard & History as Pending.");
    window.location.href = "squad-dashboard.html";
  };
</script>

</body>
</html>
