<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking-Off – BrickBook</title>

<style>
/* ---------------------------------------
   LIGHT MODE VARIABLES (DEFAULT)
---------------------------------------- */
:root {
  --bg: #f5f7fb;
  --card-bg: rgba(255,255,255,0.7);
  --card-border: rgba(0,0,0,0.06);
  --text-main: #1f2937;
  --text-light: #6b7280;
  --primary: #1b73e8;
  --primary-hover: #155ac2;
  --shadow: 0 8px 28px rgba(0,0,0,0.07);
  --glass-blur: blur(18px);
}

/* ---------------------------------------
   DARK MODE VARIABLES
---------------------------------------- */
body.dark {
  --bg: #0b1220;
  --card-bg: rgba(15,23,42,0.65);
  --card-border: rgba(255,255,255,0.09);
  --text-main: #e5e7eb;
  --text-light: #9ca3af;
  --primary: #3ba4ff;
  --primary-hover: #1d8fe6;
  --shadow: 0 8px 40px rgba(0,0,0,0.6);
}

/* ---------------------------------------
   GLOBAL RESET
---------------------------------------- */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  background: var(--bg);
  font-family: "Inter", Arial, sans-serif;
  color: var(--text-main);
  transition: background 0.3s ease;
}
<script>
// Correct login guard for squad
if (!sessionStorage.getItem("squadUser")) {
    window.location.href = "squad-login.html";
}
</script>

/* ---------------------------------------
   HEADER – GLASS + ANIMATED GRADIENT LINE
---------------------------------------- */
header {
  position: sticky;
  top: 0;
  z-index: 1000;
  backdrop-filter: var(--glass-blur);
  background: rgba(255,255,255,0.35);
  border-bottom: 1px solid var(--card-border);
  padding: 16px 22px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
body.dark header {
  background: rgba(15,23,42,0.45);
}

header::after {
  /* animated gradient underline */
  content: "";
  position: absolute;
  left: 0;
  bottom: -2px;
  width: 100%;
  height: 3px;
  background: linear-gradient(
    90deg,
    #1b73e8,
    #06b6d4,
    #3ba4ff,
    #1b73e8
  );
  background-size: 300% 100%;
  animation: headerLine 6s linear infinite;
}
@keyframes headerLine {
  0% { background-position: 0%; }
  100% { background-position: 300%; }
}

.logo {
  font-size: 22px;
  font-weight: 800;
  letter-spacing: -0.5px;
}

nav {
  display: flex;
  gap: 24px;
  align-items: center;
}
nav a {
  color: var(--text-main);
  font-weight: 600;
  text-decoration: none;
}
nav a:hover {
  color: var(--primary);
}

/* Dark mode toggle */
.toggle {
  width: 44px;
  height: 24px;
  background: rgba(0,0,0,0.15);
  border-radius: 999px;
  padding: 3px;
  cursor: pointer;
}
.toggle-thumb {
  width: 18px;
  height: 18px;
  background: white;
  border-radius: 50%;
  transition: transform 0.25s ease;
}
body.dark .toggle {
  background: rgba(255,255,255,0.18);
}
body.dark .toggle-thumb {
  transform: translateX(20px);
}

/* MOBILE NAV */
.hamburger {
  display: none;
  font-size: 30px;
  cursor: pointer;
}

.mobile-menu {
  display: none;
  flex-direction: column;
  background: var(--card-bg);
  border-bottom: 1px solid var(--card-border);
  backdrop-filter: var(--glass-blur);
  padding: 14px;
}
.mobile-menu a {
  padding: 10px 0;
  text-decoration: none;
  color: var(--text-main);
  border-bottom: 1px solid var(--card-border);
}

/* ---------------------------------------
   PAGE WRAPPER
---------------------------------------- */
.wrapper {
  max-width: 900px;
  margin: auto;
  padding: 30px 18px 80px;
}

h1 {
  font-size: 32px;
  font-weight: 800;
  margin-bottom: 10px;
}
.subtitle {
  color: var(--text-light);
  margin-bottom: 22px;
}

/* ---------------------------------------
   CARDS (Glass Theme)
---------------------------------------- */
.card,
.plot-card,
.split-card {
  background: var(--card-bg);
  backdrop-filter: var(--glass-blur);
  border: 1px solid var(--card-border);
  border-radius: 18px;
  padding: 20px;
  margin-bottom: 22px;
  box-shadow: var(--shadow);
  animation: fadeIn 0.4s ease;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ---------------------------------------
   SELECTS
---------------------------------------- */
select {
  width: 100%;
  padding: 12px;
  font-size: 15px;
  border-radius: 12px;
  border: 1px solid var(--card-border);
  background: rgba(255,255,255,0.6);
  color: var(--text-main);
}
body.dark select {
  background: rgba(255,255,255,0.08);
}

/* ---------------------------------------
   TABLE (Measurements)
---------------------------------------- */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 12px;
}
thead {
  background: rgba(255,255,255,0.25);
}
th, td {
  padding: 8px;
  font-size: 14px;
  border-bottom: 1px solid var(--card-border);
}
input[type="number"],
input[type="text"] {
  width: 100%;
  padding: 8px 10px;
  border-radius: 10px;
  border: 1px solid var(--card-border);
  background: rgba(255,255,255,0.6);
}
body.dark input[type="number"],
body.dark input[type="text"] {
  background: rgba(255,255,255,0.1);
}

/* ---------------------------------------
   NOTES / PHOTOS
---------------------------------------- */
textarea {
  width: 100%;
  height: 80px;
  padding: 12px;
  border-radius: 12px;
  border: 1px solid var(--card-border);
  background: rgba(255,255,255,0.6);
}
.photo-preview img {
  width: 85px;
  height: 85px;
  border-radius: 10px;
  object-fit: cover;
  border: 1px solid var(--card-border);
}

/* ---------------------------------------
   BUTTONS
---------------------------------------- */
.btn {
  padding: 12px 20px;
  border-radius: 12px;
  cursor: pointer;
  font-size: 15px;
  font-weight: 700;
  border: none;
}

.btn-primary {
  background: var(--primary);
  color: white;
  box-shadow: 0 6px 20px rgba(27,115,232,0.35);
}
.btn-primary:hover {
  background: var(--primary-hover);
}

.btn-secondary {
  background: rgba(255,255,255,0.55);
  border: 1px solid var(--card-border);
  color: var(--primary);
}
body.dark .btn-secondary {
  background: rgba(255,255,255,0.1);
}

/* ---------------------------------------
   SPLIT ROW
---------------------------------------- */
.split-row {
  display: grid;
  grid-template-columns: 1fr 70px 100px 120px;
  gap: 10px;
  margin-bottom: 10px;
}

/* ---------------------------------------
   TOTALS
---------------------------------------- */
.grand-total-box {
  text-align: right;
  font-size: 22px;
  font-weight: 800;
  margin-top: 25px;
}

/* ---------------------------------------
   MOBILE
---------------------------------------- */
@media(max-width: 768px) {
  nav { display: none; }
  .hamburger { display: block; }
  .split-row {
    grid-template-columns: 1fr 60px 90px 90px;
  }
  .btn-primary, .btn-secondary {
    width: 100%;
    margin-top: 10px;
  }
}
</style>
</head>
<body>

<script>
/* -------------------------------
   SQUAD LOGIN PROTECT
-------------------------------- */
if (!sessionStorage.getItem("squadLoggedIn")) {
  window.location.href = "squad-login.html";
}
</script>

<!-- ----------------------------------
     HEADER
----------------------------------- -->
<header>
  <div class="logo">BrickBook</div>

  <nav>
    <a href="booking.html">Booking-Off</a>
    <a href="squad-dashboard.html">Dashboard</a>
    <a href="squad-history.html">History</a>
    <a href="#" onclick="logout()">Logout</a>

    <div class="toggle" onclick="toggleDark()">
      <div class="toggle-thumb"></div>
    </div>
  </nav>

  <div class="hamburger" onclick="toggleMenu()">☰</div>
</header>

<div class="mobile-menu" id="mobileMenu">
  <a href="booking.html">Booking-Off</a>
  <a href="squad-dashboard.html">Dashboard</a>
  <a href="squad-history.html">History</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<script>
function toggleMenu(){
  const m=document.getElementById("mobileMenu");
  m.style.display=m.style.display==="flex"?"none":"flex";
}
function logout(){
  sessionStorage.removeItem("squadLoggedIn");
  window.location.href="squad-login.html";
}
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",document.body.classList.contains("dark")?"dark":"light");
}
if(localStorage.getItem("theme")==="dark"){
  document.body.classList.add("dark");
}
</script>

<!-- ----------------------------------
     MAIN WRAPPER
----------------------------------- -->
<div class="wrapper">

  <h1>Booking-Off</h1>
  <div class="subtitle">Select squad + site to load measurements.</div>

  <!-- Squad / Site Select -->
  <div class="card">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label>Squad</label>
        <select id="select-squad">
          <option value="">Select Squad…</option>
        </select>
      </div>
      <div>
        <label>Site</label>
        <select id="select-site">
          <option value="">Select Site…</option>
        </select>
      </div>
    </div>
  </div>

  <button class="btn btn-secondary" onclick="addPlot()">+ Add Plot</button>

  <div id="plots-container"></div>

  <div class="grand-total-box">
    Grand Total: £<span id="grand-total">0.00</span>
  </div>

  <!-- Squad Split -->
  <div class="split-card">
    <h2 style="margin-bottom:14px;">Squad Split</h2>

    <div class="split-row" style="font-weight:700;">
      <div>Name</div>
      <div>%</div>
      <div>Wages</div>
      <div>After CIS</div>
    </div>

    <div id="split-container"></div>

    <div class="grand-total-box">
      Total After CIS: £<span id="final-total-cis">0.00</span>
    </div>
  </div>

  <button class="btn btn-primary" onclick="submitBooking()">Submit Booking-Off</button>

</div>

<script>
/* ---------------------------------------
   LOAD PRICING MANAGER DATA
---------------------------------------- */
const PRICING_KEY="brickbook_pricing_state";
let pricing={squads:[],sites:[],profiles:[]};

(function loadPricing(){
  const saved=localStorage.getItem(PRICING_KEY);
  if(saved){
    try{pricing=JSON.parse(saved);}catch(e){}
  }
})();

/* Fill dropdowns */
(function fill(){
  const s1=document.getElementById("select-squad");
  const s2=document.getElementById("select-site");

  pricing.squads.forEach(x=>{
    let o=document.createElement("option");
    o.value=x;o.textContent=x;
    s1.appendChild(o);
  });

  pricing.sites.forEach(x=>{
    let o=document.createElement("option");
    o.value=x;o.textContent=x;
    s2.appendChild(o);
  });
})();

function getActiveFields(){
  const squad=document.getElementById("select-squad").value;
  const site=document.getElementById("select-site").value;
  return pricing.profiles.find(p=>p.squad===squad && p.site===site)?.fields || [];
}

/* ---------------------------------------
   ADD PLOT
---------------------------------------- */
function addPlot(){
  const fields=getActiveFields();
  if(!fields.length){
    alert("Select a squad + site with pricing profile first.");
    return;
  }

  const id=Date.now();
  const card=document.createElement("div");
  card.className="plot-card";

  card.innerHTML=`
    <button class="delete-btn" onclick="this.closest('.plot-card').remove();calcGrandTotal();calcSplitTotals();">Delete</button>

    <div style="font-weight:600;margin-bottom:6px;">
      Plot <input type="text" class="plot-number" placeholder="e.g. 12A">
    </div>

    <table>
      <thead><tr><th>Measurement</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead>
      <tbody>
        ${fields.map(f=>`
          <tr>
            <td>${f.name}</td>
            <td><input type="number" class="qty" oninput="calcRow(this);calcPlot(this)"></td>
            <td><input type="number" class="rate" value="${f.rate}" readonly></td>
            <td><input type="number" class="total" readonly></td>
          </tr>`).join("")}
      </tbody>
    </table>

    <label style="margin-top:10px;">Notes</label>
    <textarea class="plot-notes" placeholder="Progress, issues, materials…"></textarea>

    <label style="margin-top:10px;">Upload Photos</label>
    <input type="file" accept="image/*" onchange="previewPhoto(this,'${id}')">

    <button class="btn btn-secondary" style="margin-top:8px;" onclick="addPhotoField(this,'${id}')">+ Add Photo</button>

    <div class="photo-preview" id="preview-${id}"></div>

    <div class="grand-total-box" style="font-size:17px;">
      Plot Total: £<span class="plot-total">0.00</span>
    </div>
  `;

  document.getElementById("plots-container").appendChild(card);
}

function previewPhoto(input,id){
  if(!input.files||!input.files[0])return;
  const img=document.createElement("img");
  img.src=URL.createObjectURL(input.files[0]);
  document.getElementById("preview-"+id).appendChild(img);
}
function addPhotoField(btn,id){
  const input=document.createElement("input");
  input.type="file";input.accept="image/*";
  input.onchange=()=>previewPhoto(input,id);
  btn.insertAdjacentElement("beforebegin",input);
}

/* ---------------------------------------
   CALCULATIONS
---------------------------------------- */
function calcRow(el){
  const tr=el.closest("tr");
  const qty=parseFloat(el.value)||0;
  const rate=parseFloat(tr.querySelector(".rate").value)||0;
  tr.querySelector(".total").value=(qty*rate).toFixed(2);
}
function calcPlot(el){
  const card=el.closest(".plot-card");
  let sum=0;
  card.querySelectorAll(".total").forEach(x=>sum+=parseFloat(x.value)||0);
  card.querySelector(".plot-total").textContent=sum.toFixed(2);
  calcGrandTotal();
  calcSplitTotals();
}
function calcGrandTotal(){
  let sum=0;
  document.querySelectorAll(".plot-total").forEach(x=>sum+=parseFloat(x.textContent)||0);
  document.getElementById("grand-total").textContent=sum.toFixed(2);
}

/* ---------------------------------------
   SQUAD SPLIT
---------------------------------------- */
const splitContainer=document.getElementById("split-container");
for(let i=0;i<5;i++) addSplitRow();

function addSplitRow(){
  const r=document.createElement("div");
  r.className="split-row";
  r.innerHTML=`
    <input type="text" class="split-name" placeholder="Person">
    <input type="number" class="split-percent" oninput="percentChanged(this)">
    <input type="number" class="split-wages" oninput="wagesChanged(this)">
    <input type="number" class="split-cis" readonly>
  `;
  splitContainer.appendChild(r);
}

function percentChanged(el){
  const r=el.closest(".split-row");
  const pct=parseFloat(el.value)||0;
  const grand=parseFloat(document.getElementById("grand-total").textContent)||0;
  const wages=grand*(pct/100);
  r.querySelector(".split-wages").value=wages.toFixed(2);
  r.querySelector(".split-cis").value=(wages*0.8).toFixed(2);
  calcSplitTotals();
}
function wagesChanged(el){
  const r=el.closest(".split-row");
  const wages=parseFloat(el.value)||0;
  const grand=parseFloat(document.getElementById("grand-total").textContent)||0;
  if(grand>0){
    r.querySelector(".split-percent").value=((wages/grand)*100).toFixed(2);
  }
  r.querySelector(".split-cis").value=(wages*0.8).toFixed(2);
  calcSplitTotals();
}

function calcSplitTotals(){
  let s=0;
  document.querySelectorAll(".split-cis").forEach(x=>s+=parseFloat(x.value)||0);
  document.getElementById("final-total-cis").textContent=s.toFixed(2);
}

/* ---------------------------------------
   SUBMIT ACTION
---------------------------------------- */
function submitBooking(){
  alert("Booking-Off Submitted!");
}
</script>

</body>
</html>
