<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Booking-Off – BrickBook</title>

<style>
/* ---------------------------------------
   LIGHT MODE VARIABLES (DEFAULT)
---------------------------------------- */
:root {
  --bg: #f5f7fb;
  --card-bg: rgba(255,255,255,0.7);
  --card-border: rgba(0,0,0,0.06);
  --text-main: #1f2937;
  --text-light: #6b7280;
  --primary: #1b73e8;
  --primary-hover: #155ac2;
  --shadow: 0 8px 28px rgba(0,0,0,0.07);
  --glass-blur: blur(18px);
}

/* ---------------------------------------
   DARK MODE VARIABLES
---------------------------------------- */
body.dark {
  --bg: #0b1220;
  --card-bg: rgba(15,23,42,0.65);
  --card-border: rgba(255,255,255,0.09);
  --text-main: #e5e7eb;
  --text-light: #9ca3af;
  --primary: #3ba4ff;
  --primary-hover: #1d8fe6;
  --shadow: 0 8px 40px rgba(0,0,0,0.6);
}

/* ---------------------------------------
   GLOBAL RESET
---------------------------------------- */
* { margin:0; padding:0; box-sizing:border-box; }

body {
  background: var(--bg);
  font-family: "Inter", Arial, sans-serif;
  color: var(--text-main);
  transition: 0.25s ease;
}

/* ---------------------------------------
   HEADER (glass)
---------------------------------------- */
header {
  position: sticky;
  top: 0;
  z-index: 1000;
  background: var(--card-bg);
  backdrop-filter: var(--glass-blur);
  padding: 16px 22px;
  display:flex;
  justify-content:space-between;
  align-items:center;
  border-bottom:1px solid var(--card-border);
}

.logo { font-size:22px; font-weight:800; }

nav { display:flex; gap:22px; align-items:center; }
nav a {
  text-decoration:none;
  color:var(--text-main);
  font-weight:600;
}
nav a:hover { color:var(--primary); }

.toggle {
  width:44px; height:24px; border-radius:999px;
  background:rgba(0,0,0,0.15);
  padding:3px; cursor:pointer;
}
.toggle-thumb {
  width:18px; height:18px;
  background:white;
  border-radius:50%;
  transition:0.25s;
}
body.dark .toggle { background:rgba(255,255,255,0.3); }
body.dark .toggle-thumb { transform:translateX(20px); }

.hamburger { display:none; font-size:30px; cursor:pointer; }

.mobile-menu {
  display:none;
  flex-direction:column;
  background:var(--card-bg);
  padding:14px;
  border-bottom:1px solid var(--card-border);
}
.mobile-menu a {
  padding:10px 0;
  text-decoration:none;
  color:var(--text-main);
  border-bottom:1px solid var(--card-border);
}

/* ---------------------------------------
   WRAPPER
---------------------------------------- */
.wrapper {
  max-width:900px;
  margin:auto;
  padding:30px 18px 80px;
}

h1 { font-size:32px; font-weight:800; }
.subtitle { color:var(--text-light); margin-bottom:20px; }

/* ---------------------------------------
   CARDS
---------------------------------------- */
.card,
.plot-card,
.split-card {
  background:var(--card-bg);
  border:1px solid var(--card-border);
  border-radius:18px;
  padding:20px;
  margin-bottom:22px;
  backdrop-filter:var(--glass-blur);
  box-shadow:var(--shadow);
}

table { width:100%; border-collapse:collapse; margin-top:10px; }
thead { background:rgba(255,255,255,0.2); }

th,td {
  padding:8px;
  border-bottom:1px solid var(--card-border);
  font-size:14px;
}

input, select, textarea {
  width:100%;
  padding:10px;
  border-radius:10px;
  border:1px solid var(--card-border);
  background:rgba(255,255,255,0.7);
}
body.dark input, body.dark select, body.dark textarea {
  background:rgba(255,255,255,0.1);
}

textarea { height:80px; }

/* photo preview */
.photo-preview img {
  width:85px; height:85px;
  border-radius:10px;
  object-fit:cover;
  margin-right:8px;
  margin-top:8px;
  border:1px solid var(--card-border);
}

/* BUTTONS */
.btn {
  padding:12px 18px;
  border-radius:12px;
  font-weight:700;
  cursor:pointer;
  border:none;
}
.btn-primary { background:var(--primary); color:white; }
.btn-primary:hover { background:var(--primary-hover); }
.btn-secondary {
  background:rgba(255,255,255,0.5);
  border:1px solid var(--card-border);
  color:var(--primary);
}

.split-row {
  display:grid;
  grid-template-columns:1fr 70px 100px 120px;
  gap:12px;
  margin-bottom:10px;
}

.grand-total-box {
  text-align:right;
  font-weight:800;
  font-size:22px;
  margin-top:20px;
}

@media(max-width:768px){
  nav { display:none; }
  .hamburger{ display:block; }
  .btn-primary,.btn-secondary { width:100%; margin-top:10px; }
  .split-row {
    grid-template-columns:1fr 60px 90px 90px;
  }
}
</style>
</head>

<body>

<script>
/* ------------------------------------------------
   FIXED LOGIN GUARD
-------------------------------------------------- */
if (!sessionStorage.getItem("squadUser")) {
    window.location.href = "squad-login.html";
}
</script>

<header>
  <div class="logo">BrickBook</div>

  <nav>
    <a href="booking.html">Booking-Off</a>
    <a href="squad-dashboard.html">Dashboard</a>
    <a href="squad-history.html">History</a>
    <a href="#" onclick="logout()">Logout</a>

    <div class="toggle" onclick="toggleDark()">
      <div class="toggle-thumb"></div>
    </div>
  </nav>

  <div class="hamburger" onclick="toggleMenu()">☰</div>
</header>

<div id="mobileMenu" class="mobile-menu">
  <a href="booking.html">Booking-Off</a>
  <a href="squad-dashboard.html">Dashboard</a>
  <a href="squad-history.html">History</a>
  <a href="#" onclick="logout()">Logout</a>
</div>

<script>
function toggleMenu(){
  let m=document.getElementById("mobileMenu");
  m.style.display = m.style.display==="flex" ? "none" : "flex";
}

function logout(){
  sessionStorage.removeItem("squadUser");
  window.location.href = "squad-login.html";
}

function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.setItem("theme",document.body.classList.contains("dark"));
}

if(localStorage.getItem("theme")==="true"){
  document.body.classList.add("dark");
}
</script>

<div class="wrapper">

  <h1>Booking-Off</h1>
  <div class="subtitle">Select squad + site to load measurements.</div>

  <!-- Squad + Site Selector -->
  <div class="card">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label>Squad</label>
        <select id="select-squad"><option value="">Select Squad…</option></select>
      </div>
      <div>
        <label>Site</label>
        <select id="select-site"><option value="">Select Site…</option></select>
      </div>
    </div>
  </div>

  <button class="btn btn-secondary" onclick="addPlot()">+ Add Plot</button>

  <div id="plots-container"></div>

  <div class="grand-total-box">
    Grand Total: £<span id="grand-total">0.00</span>
  </div>

  <!-- Squad Split -->
  <div class="split-card">
    <h2>Squad Split</h2>

    <div class="split-row" style="font-weight:700;">
      <div>Name</div><div>%</div><div>Wages</div><div>After CIS</div>
    </div>

    <div id="split-container"></div>

    <div class="grand-total-box">
      Total After CIS: £<span id="final-total-cis">0.00</span>
    </div>
  </div>

  <button class="btn btn-primary" onclick="submitBooking()">Submit Booking-Off</button>

</div>

<script>
/* ------------------------------------------------
   LOAD PRICING MANAGER DATA
-------------------------------------------------- */
const PRICING_KEY="brickbook_pricing_state";
let pricing={squads:[],sites:[],profiles:[]};

if(localStorage.getItem(PRICING_KEY)){
  pricing = JSON.parse(localStorage.getItem(PRICING_KEY));
}

/* populate squad + site selects */
pricing.squads.forEach(s=>{
  let o=document.createElement("option"); o.value=s; o.textContent=s;
  document.getElementById("select-squad").appendChild(o);
});
pricing.sites.forEach(s=>{
  let o=document.createElement("option"); o.value=s; o.textContent=s;
  document.getElementById("select-site").appendChild(o);
});

function getActiveFields(){
  let s=document.getElementById("select-squad").value;
  let t=document.getElementById("select-site").value;
  return pricing.profiles.find(p=>p.squad===s && p.site===t)?.fields || [];
}

/* ------------------------------------------------
   ADD PLOT
-------------------------------------------------- */
function addPlot(){
  const fields=getActiveFields();
  if(!fields.length){ alert("Select squad + site first."); return; }

  const id=Date.now();
  const card=document.createElement("div");
  card.className="plot-card";

  card.innerHTML=`
    <button class="btn btn-secondary" onclick="this.closest('.plot-card').remove();calcGrandTotal();calcSplitTotals();">Delete Plot</button>

    <div style="margin-top:10px;font-weight:600;">
      Plot <input type="text" class="plot-number" placeholder="e.g. 24A">
    </div>

    <table>
      <thead><tr><th>Measurement</th><th>Qty</th><th>Rate</th><th>Total</th></tr></thead>
      <tbody>
        ${fields.map(f=>`
          <tr>
            <td>${f.name}</td>
            <td><input type="number" class="qty" oninput="calcRow(this);calcPlot(this)"></td>
            <td><input type="number" class="rate" value="${f.rate}" readonly></td>
            <td><input type="number" class="total" readonly></td>
          </tr>
        `).join("")}
      </tbody>
    </table>

    <label style="margin-top:10px;">Notes</label>
    <textarea class="plot-notes"></textarea>

    <label style="margin-top:10px;">Photos</label>
    <input type="file" accept="image/*" onchange="previewPhoto(this,'${id}')">
    <button class="btn btn-secondary" style="margin-top:6px;" onclick="addPhotoField(this,'${id}')">+ Add Photo</button>

    <div class="photo-preview" id="preview-${id}"></div>

    <div class="grand-total-box" style="font-size:17px;">
      Plot Total: £<span class="plot-total">0.00</span>
    </div>
  `;

  document.getElementById("plots-container").appendChild(card);
}

function previewPhoto(input,id){
  if(!input.files[0]) return;
  let img=document.createElement("img");
  img.src=URL.createObjectURL(input.files[0]);
  document.getElementById("preview-"+id).appendChild(img);
}

function addPhotoField(btn,id){
  let i=document.createElement("input");
  i.type="file";
  i.accept="image/*";
  i.onchange = ()=>previewPhoto(i,id);
  btn.insertAdjacentElement("beforebegin",i);
}

/* ------------------------------------------------
   CALCULATIONS
-------------------------------------------------- */
function calcRow(el){
  let tr=el.closest("tr");
  let qty=parseFloat(el.value)||0;
  let rate=parseFloat(tr.querySelector(".rate").value)||0;
  tr.querySelector(".total").value=(qty*rate).toFixed(2);
}

function calcPlot(el){
  let card=el.closest(".plot-card");
  let sum=0;
  card.querySelectorAll(".total").forEach(t=>sum+=parseFloat(t.value)||0);
  card.querySelector(".plot-total").textContent=sum.toFixed(2);
  calcGrandTotal();
  calcSplitTotals();
}

function calcGrandTotal(){
  let g=0;
  document.querySelectorAll(".plot-total").forEach(c=>g+=parseFloat(c.textContent)||0);
  document.getElementById("grand-total").textContent=g.toFixed(2);
}

/* ------------------------------------------------
   SQUAD SPLIT
-------------------------------------------------- */
const splitContainer=document.getElementById("split-container");
for(let i=0;i<5;i++) addSplitRow();

function addSplitRow(){
  let r=document.createElement("div");
  r.className="split-row";
  r.innerHTML=`
    <input type="text" class="split-name">
    <input type="number" class="split-percent" oninput="percentChanged(this)">
    <input type="number" class="split-wages" oninput="wagesChanged(this)">
    <input type="number" class="split-cis" readonly>
  `;
  splitContainer.appendChild(r);
}

function percentChanged(el){
  const row=el.closest(".split-row");
  const pct=parseFloat(el.value)||0;
  const grand=parseFloat(document.getElementById("grand-total").textContent)||0;
  const wages=grand*(pct/100);
  row.querySelector(".split-wages").value=wages.toFixed(2);
  row.querySelector(".split-cis").value=(wages*0.8).toFixed(2);
  calcSplitTotals();
}

function wagesChanged(el){
  const row=el.closest(".split-row");
  const wages=parseFloat(el.value)||0;
  const grand=parseFloat(document.getElementById("grand-total").textContent)||0;

  if(grand>0){
    row.querySelector(".split-percent").value=((wages/grand)*100).toFixed(2);
  }
  row.querySelector(".split-cis").value=(wages*0.8).toFixed(2);
  calcSplitTotals();
}

function calcSplitTotals(){
  let total=0;
  document.querySelectorAll(".split-cis").forEach(c=>total+=parseFloat(c.value)||0);
  document.getElementById("final-total-cis").textContent=total.toFixed(2);
}

/* ------------------------------------------------
   SUBMIT
-------------------------------------------------- */
function submitBooking(){
  alert("Booking-Off submitted successfully!");
}
</script>

</body>
</html>
