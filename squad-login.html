<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Squad Login â€“ BrickBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/style.css">

<script type="module" src="./firebase.js"></script>

<style>
  body { margin:0; font-family:"Inter",sans-serif; background:#F5F7FA; }
  .wrapper { max-width:420px; margin:40px auto; padding:20px; }
  .card { background:white; padding:26px; border-radius:16px;
          border:1px solid #E5E7EB; box-shadow:0 8px 28px rgba(0,0,0,0.06); }
  .title { font-size:26px; font-weight:800; text-align:center; margin-bottom:8px; }
  input { width:100%; padding:14px; border-radius:10px; border:1px solid #E5E7EB; margin-bottom:14px; }
  .btn-primary { width:100%; background:#1B73E8; padding:14px; border-radius:10px;
                 color:white; font-weight:700; border:none; cursor:pointer; }
  .link { text-align:center; margin-top:10px; font-size:14px; }
  .forgot-link { color:#1B73E8; text-decoration:none; cursor:pointer; }
  .error-box { background:#ffe7e7; color:#b30000; padding:10px; border-radius:6px; margin-bottom:12px; display:none; }
  .success-box { background:#e7ffe9; color:#008a1c; padding:10px; border-radius:6px; margin-bottom:12px; display:none; }
</style>

</head>
<body>

<div class="wrapper">

  <div class="card">

    <div class="title">Squad Login</div>
    <p style="text-align:center; color:#6B7280; margin-bottom:20px;">
      Access your BrickBook squad dashboard
    </p>

    <div id="errorBox" class="error-box"></div>
    <div id="successBox" class="success-box"></div>

    <input type="email" id="email" placeholder="Email address">
    <input type="password" id="password" placeholder="Password">

    <button class="btn-primary" id="loginBtn">Login</button>

    <div class="link">
      <a class="forgot-link" id="forgotBtn">Forgot your password?</a>
    </div>

    <div class="link" style="margin-top:4px;">
      <a href="contractor-login.html">Contractor Login</a>
    </div>

  </div>

</div>

<script type="module">
  import { auth, db } from "./firebase.js";

  import {
    signInWithEmailAndPassword,
    sendPasswordResetEmail
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    doc,
    getDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


  const errorBox = document.getElementById("errorBox");
  const successBox = document.getElementById("successBox");

  function showError(msg) {
    errorBox.textContent = msg;
    errorBox.style.display = "block";
    successBox.style.display = "none";
  }

  function showSuccess(msg) {
    successBox.textContent = msg;
    successBox.style.display = "block";
    errorBox.style.display = "none";
  }

  /* ======================================
      LOGIN HANDLER
  ====================================== */
  document.getElementById("loginBtn").onclick = async () => {
    const email = document.getElementById("email").value.trim().toLowerCase();
    const password = document.getElementById("password").value.trim();

    if (!email || !password) {
      showError("Please enter your email and password.");
      return;
    }

    try {
      const result = await signInWithEmailAndPassword(auth, email, password);
      const user = result.user;

      // Fetch squad record
      const squadRef = doc(db, "squads", user.uid);
      const snap = await getDoc(squadRef);

      if (!snap.exists()) {
        // Prevent contractors using squad login
        showError("This login is for squad members only.");
        return;
      }

      // Store squad identity for dashboard
      sessionStorage.setItem("squadUser", user.uid);
      localStorage.setItem("lastSquadUser", user.uid);

      window.location.href = "squad-dashboard.html";

    } catch (err) {
      if (err.code === "auth/invalid-credential") {
        showError("Incorrect email or password.");
      } else {
        showError(err.message);
      }
    }
  };


  /* ======================================
      FORGOT PASSWORD
  ====================================== */
  document.getElementById("forgotBtn").onclick = async () => {
    const email = document.getElementById("email").value.trim().toLowerCase();
    if (!email) {
      showError("Enter your email first.");
      return;
    }

    try {
      await sendPasswordResetEmail(auth, email);
      showSuccess("Reset link sent! Check your inbox.");
    } catch (err) {
      showError(err.message);
    }
  };
</script>

</body>
</html>
