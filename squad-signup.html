<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Squad Sign Up â€“ BrickBook</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="assets/style.css">

<script type="module" src="./firebase.js"></script>

<style>
  body { font-family: "Inter", sans-serif; background:#F5F7FA; }
  .wrapper { max-width:420px;margin:40px auto;padding:20px; }
  .card { background:white;padding:26px;border-radius:16px;
          border:1px solid #E5E7EB;box-shadow:0 8px 28px rgba(0,0,0,0.06); }
  .card-title { font-size:24px;font-weight:800;margin-bottom:12px;text-align:center; }
  input { width:100%;padding:14px;border-radius:10px;border:1px solid #E5E7EB;margin-bottom:14px; }
  .btn-primary { width:100%;padding:14px;border-radius:12px;background:#1B73E8;color:white;
                 font-weight:700;border:none;cursor:pointer;margin-top:10px; }
  .info { background:#E9F1FF;padding:14px;border-left:4px solid #1B73E8;border-radius:6px;margin-bottom:18px; }
</style>
</head>

<body>

<div class="wrapper">
  <div class="card">

    <div class="card-title">Finish Squad Sign Up</div>

    <!-- invite message -->
    <div id="inviteInfo" class="info" style="display:none;"></div>

    <!-- show after firebase signs user in -->
    <div id="setupForm" style="display:none;">
      <input type="text" id="fullName" placeholder="Full Name">
      <input type="password" id="password" placeholder="Create Password">
      <button class="btn-primary" id="finishBtn">Create Squad Account</button>
    </div>

  </div>
</div>

<script type="module">
  import { auth, db } from "./firebase.js";

  import {
    isSignInWithEmailLink,
    signInWithEmailLink,
    updatePassword
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    doc,
    setDoc,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  /* ======================================================
        1. Detect Firebase email invite link
  ====================================================== */
  const url = window.location.href;
  const inviteBox = document.getElementById("inviteInfo");
  const setupForm = document.getElementById("setupForm");

  if (isSignInWithEmailLink(auth, url)) {

    // ask user to confirm email (Firebase required)
    let email = window.localStorage.getItem("squadInviteEmail");
    if (!email) email = prompt("Confirm your email address:");

    // sign them in
    const result = await signInWithEmailLink(auth, email, url);

    inviteBox.style.display = "block";
    inviteBox.innerHTML = `
      <strong>Email verified!</strong><br>
      Complete your squad account setup below.
    `;

    setupForm.style.display = "block";

    /* ==============================================
         2. Handle final squad setup
    ============================================== */
    document.getElementById("finishBtn").onclick = async () => {
      const fullName = document.getElementById("fullName").value.trim();
      const password = document.getElementById("password").value.trim();

      if (!fullName || !password) {
        alert("Enter your full name and create a password.");
        return;
      }

      try {
        // Set password on Firebase user
        await updatePassword(auth.currentUser, password);

        /* ============================================
             3. Save squad in Firestore
        ============================================ */
        const squadId = auth.currentUser.uid;

        await setDoc(
          doc(db, "squads", squadId),
          {
            name: fullName,
            email: auth.currentUser.email,
            contractorId: "PENDING",  // contractor ID auto-filled later
            createdAt: serverTimestamp(),
            status: "active"
          }
        );

        alert("Your squad account is ready!");
        window.location.href = "squad-dashboard.html";

      } catch (err) {
        console.error(err);
        alert("Error finishing setup: " + err.message);
      }
    };

  } else {
    inviteBox.style.display = "block";
    inviteBox.innerHTML = `
      <strong>Invalid invite.</strong><br>
      Please use the link sent to your email.
    `;
  }
</script>

</body>
</html>
