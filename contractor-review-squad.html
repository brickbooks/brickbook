<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Review Submission – BrickBook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/style.css" />

  <style>
    /* Page-specific styling */

    .review-squad-hero {
      background: linear-gradient(
        135deg,
        rgba(27,115,232,0.18),
        rgba(27,115,232,0.04)
      );
      border-radius: 20px;
      padding: 24px 22px;
      box-shadow: var(--shadow-soft);
      margin-top: 24px;
      margin-bottom: 22px;
    }

    .review-squad-header {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      align-items: flex-start;
      flex-wrap: wrap;
    }

    .review-squad-meta {
      font-size: 13px;
      color: var(--text-muted);
      text-align: right;
    }

    .pill-link {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      font-size: 12px;
      text-decoration: none;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    /* Tabs */
    .tabs {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 14px;
    }

    .tab-btn {
      border: none;
      background: transparent;
      padding: 8px 12px;
      border-radius: 999px 999px 0 0;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      color: var(--text-muted);
    }

    .tab-btn.active {
      background: #ffffff;
      color: var(--blue);
      border: 1px solid var(--border-subtle);
      border-bottom-color: #ffffff;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Plots / photos */
    .plot-card {
      margin-bottom: 18px;
      padding: 14px 12px;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      background: #f9fbff;
    }

    .plot-title {
      font-size: 15px;
      font-weight: 700;
      margin-bottom: 6px;
    }

    .plot-notes {
      font-size: 13px;
      color: var(--text-muted);
      margin: 8px 0 10px 0;
    }

    .photo-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 6px;
    }

    .photo-grid img {
      width: 110px;
      height: 110px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid var(--border-subtle);
    }

    @media (max-width: 640px) {
      .review-squad-header {
        flex-direction: column;
      }
      .review-squad-meta {
        text-align: left;
      }
      .photo-grid img {
        width: 90px;
        height: 90px;
      }
    }
  </style>
</head>

<body class="page" data-page="review-squad">

<!-- LOGIN GUARD -->
<script>
  if (!sessionStorage.getItem("loggedIn")) {
    window.location.href = "contractor-login.html";
  }
</script>

<!-- GLOBAL HEADER (HOME / BOOKING / CONTRACTOR / SQUAD) -->
<header class="site-header">
  <div class="header-inner">
    <div class="logo">BrickBook</div>
    <nav class="nav">
      <a href="index.html">Home</a>
      <a href="booking.html">Booking</a>
      <a href="contractor-login.html">Contractor</a>
      <a href="squad-login.html">Squad</a>
    </nav>
    <div class="hamburger" onclick="toggleMenu()">☰</div>
  </div>
</header>

<div id="mobileMenu" class="mobile-nav">
  <a href="index.html">Home</a>
  <a href="booking.html">Booking</a>
  <a href="contractor-login.html">Contractor Login</a>
  <a href="squad-login.html">Squad Login</a>
</div>

<main class="container">

  <!-- HERO -->
  <section class="review-squad-hero">
    <a href="approvals.html" class="pill-link">← Back to approvals</a>
    <div class="review-squad-header">
      <div>
        <h1 class="h1" style="font-size:26px; margin-bottom:4px;">
          Review submission – <span id="heroSquad">Squad</span>
        </h1>
        <div class="text-muted" style="font-size:14px;">
          Inspect plots, photos and squad splits before approving.
        </div>
      </div>
      <div class="review-squad-meta">
        <div>
          Status:
          <span id="heroStatus" class="status-pill status-pill--pending">pending</span>
        </div>
        <div>Submitted: <span id="heroSubmitted">Today 14:02</span></div>
        <div>Grand total: £<span id="heroTotal">0.00</span></div>
      </div>
    </div>
  </section>

  <!-- TABS + PANELS -->
  <section class="card">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-tab="overview" onclick="showTab('overview', this)">Overview</button>
      <button class="tab-btn" data-tab="plots" onclick="showTab('plots', this)">Plots</button>
      <button class="tab-btn" data-tab="photos" onclick="showTab('photos', this)">Photos</button>
      <button class="tab-btn" data-tab="split" onclick="showTab('split', this)">Squad split</button>
      <button class="tab-btn" data-tab="notes" onclick="showTab('notes', this)">Notes & actions</button>
    </div>

    <!-- Overview -->
    <div class="tab-panel active" id="tab-overview">
      <div class="card-sub" id="overviewSummary">
        <!-- Filled by JS -->
      </div>
    </div>

    <!-- Plots -->
    <div class="tab-panel" id="tab-plots">
      <div id="plotsContainer"></div>
    </div>

    <!-- Photos -->
    <div class="tab-panel" id="tab-photos">
      <div id="photosContainer" class="photo-grid"></div>
      <div id="noPhotosText" class="card-sub" style="margin-top:8px; display:none;">
        No photos attached for this submission.
      </div>
    </div>

    <!-- Squad split -->
    <div class="tab-panel" id="tab-split">
      <table class="table">
        <thead>
          <tr>
            <th>Worker</th>
            <th>Split %</th>
            <th>Wages (£)</th>
            <th>After CIS (£)</th>
          </tr>
        </thead>
        <tbody id="splitRows"></tbody>
      </table>
      <div style="text-align:right; font-weight:700; margin-top:10px;">
        Total paid after CIS: £<span id="totalPaid">0.00</span>
      </div>
    </div>

    <!-- Notes & actions -->
    <div class="tab-panel" id="tab-notes">
      <label for="contractorNote">Contractor note (optional)</label>
      <textarea
        id="contractorNote"
        placeholder="Reason for rejection, feedback or additional site notes..."
        style="min-height:90px;"
      ></textarea>

      <div class="row row-wrap" style="margin-top:8px;">
        <button class="btn btn-primary" type="button" onclick="approveSubmission()">
          Approve booking
        </button>
        <button class="btn btn-danger" type="button" onclick="rejectSubmission()">
          Reject booking
        </button>
      </div>
    </div>

  </section>

</main>

<footer class="site-footer">
  <div class="footer-inner">
    <span>© 2025 BrickBook</span>
    <span class="text-muted">Review submission</span>
  </div>
</footer>

<script src="assets/main.js"></script>
<script>
  // TEMP DATA (same as your original – swap for real backend later)
  let submission = {
    squad: "Team A",
    status: "pending",
    submitted: "Today 14:02",
    plots: [
      {
        plot: "44",
        notes: "Good progress today.",
        photos: ["https://picsum.photos/200?1", "https://picsum.photos/200?2"],
        rows: [
          { measurement: "Bricks", qty: 900, rate: 0.6 },
          { measurement: "Trench", qty: 4, rate: 25 },
          { measurement: "100mm", qty: 12, rate: 16 }
        ]
      },
      {
        plot: "45",
        notes: "Rain slowed things down.",
        photos: ["https://picsum.photos/200?3"],
        rows: [
          { measurement: "Bricks", qty: 600, rate: 0.6 },
          { measurement: "Commons", qty: 150, rate: 0.35 },
          { measurement: "Squad Hours", qty: 8, rate: 50 }
        ]
      }
    ],
    split: [
      { name: "John", percent: 40 },
      { name: "Ryan", percent: 30 },
      { name: "Sam", percent: 30 }
    ]
  };

  // TAB HANDLER
  function showTab(tab, btn) {
    document.querySelectorAll(".tab-panel").forEach(p => {
      p.classList.toggle("active", p.id === "tab-" + tab);
    });
    document.querySelectorAll(".tab-btn").forEach(b => {
      b.classList.toggle("active", b === btn);
    });
  }

  // RENDER
  function initSubmission() {
    const heroSquad = document.getElementById("heroSquad");
    const heroStatus = document.getElementById("heroStatus");
    const heroSubmitted = document.getElementById("heroSubmitted");
    const heroTotal = document.getElementById("heroTotal");
    const overviewSummary = document.getElementById("overviewSummary");
    const plotsContainer = document.getElementById("plotsContainer");
    const photosContainer = document.getElementById("photosContainer");
    const noPhotosText = document.getElementById("noPhotosText");
    const splitRows = document.getElementById("splitRows");
    const totalPaidEl = document.getElementById("totalPaid");

    heroSquad.textContent = submission.squad;
    heroSubmitted.textContent = submission.submitted;

    // status pill
    heroStatus.textContent = submission.status;
    heroStatus.classList.remove("status-pill--pending","status-pill--approved","status-pill--rejected");
    if (submission.status === "approved") {
      heroStatus.classList.add("status-pill--approved");
    } else if (submission.status === "rejected") {
      heroStatus.classList.add("status-pill--rejected");
    } else {
      heroStatus.classList.add("status-pill--pending");
    }

    // compute totals & render plots
    let grandTotal = 0;
    let workerTotals = {};

    plotsContainer.innerHTML = "";
    photosContainer.innerHTML = "";

    submission.plots.forEach(p => {
      let plotTotal = 0;

      // table rows for measurements
      let rowsHTML = "";
      p.rows.forEach(r => {
        const total = r.qty * r.rate;
        plotTotal += total;
        rowsHTML += `
          <tr>
            <td>${r.measurement}</td>
            <td>${r.qty}</td>
            <td>£${r.rate}</td>
            <td><strong>£${total.toFixed(2)}</strong></td>
          </tr>
        `;
      });

      grandTotal += plotTotal;

      // plot card
      const plotCard = document.createElement("div");
      plotCard.className = "plot-card";
      plotCard.innerHTML = `
        <div class="plot-title">Plot ${p.plot}</div>
        <table class="table">
          <thead>
            <tr>
              <th>Measurement</th>
              <th>Qty</th>
              <th>Rate (£)</th>
              <th>Total (£)</th>
            </tr>
          </thead>
          <tbody>${rowsHTML}</tbody>
        </table>
        <div class="plot-notes"><strong>Notes:</strong> ${p.notes}</div>
        ${
          p.photos && p.photos.length
            ? `<div class="photo-grid">
                ${p.photos.map(src => `<img src="${src}" alt="Plot photo">`).join("")}
               </div>`
            : ""
        }
        <div style="text-align:right; margin-top:10px; font-weight:700;">
          Plot total: £${plotTotal.toFixed(2)}
        </div>
      `;
      plotsContainer.appendChild(plotCard);

      // photos tab grid
      if (p.photos && p.photos.length) {
        p.photos.forEach(src => {
          const img = document.createElement("img");
          img.src = src;
          img.alt = "Submission photo";
          photosContainer.appendChild(img);
        });
      }
    });

    heroTotal.textContent = grandTotal.toFixed(2);

    // photos empty state
    if (!photosContainer.children.length) {
      noPhotosText.style.display = "block";
    } else {
      noPhotosText.style.display = "none";
    }

    // overview summary text
    overviewSummary.innerHTML = `
      <p>
        <strong>${submission.squad}</strong> submitted
        <strong>${submission.plots.length}</strong> plot${submission.plots.length !== 1 ? "s" : ""}
        with a total of <strong>£${grandTotal.toFixed(2)}</strong>.
      </p>
      <p class="mt-12">
        ${submission.split.length} worker${submission.split.length !== 1 ? "s are" : " is"} on this squad split.
      </p>
    `;

    // squad split
    let totalPaid = 0;
    splitRows.innerHTML = "";

    submission.split.forEach(s => {
      const wages = grandTotal * (s.percent / 100);
      const cis = wages * 0.8;
      totalPaid += cis;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.name}</td>
        <td>${s.percent}%</td>
        <td>£${wages.toFixed(2)}</td>
        <td>£${cis.toFixed(2)}</td>
      `;
      splitRows.appendChild(tr);
    });

    totalPaidEl.textContent = totalPaid.toFixed(2);
  }

  function approveSubmission() {
    submission.status = "approved";
    alert("Booking approved!");
    initSubmission();
  }

  function rejectSubmission() {
    const note = document.getElementById("contractorNote").value.trim();
    if (note.length < 3) {
      alert("Please add a short reason for rejection.");
      return;
    }
    submission.status = "rejected";
    alert("Booking rejected.");
    initSubmission();
  }

  initSubmission();
</script>

<script>
function toggleMenu() {
  document.getElementById('mobileMenu').classList.toggle('show');
}
</script>

</body>
</html>
