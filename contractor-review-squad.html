<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Review Submission – BrickBook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <link rel="stylesheet" href="assets/style.css" />
  <script type="module" src="./firebase.js"></script>

  <style>
    .section-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 6px;
    }
    .plot-card {
      border: 1px solid var(--border-subtle);
      border-radius: 12px;
      padding: 14px;
      margin-bottom: 16px;
      background: var(--card-bg);
    }
    .plot-head {
      font-weight: 700;
      margin-bottom: 6px;
    }
    .labour-row {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #eee;
      font-size: 14px;
    }
    .labour-row:last-child {
      border-bottom: none;
    }
    .grand-total-box {
      font-size: 18px;
      font-weight: 800;
      text-align: right;
      margin-top: 12px;
    }
    .status-pill {
      padding: 6px 12px;
      border-radius: 999px;
      font-weight: 700;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .status-pill--pending {
      background: #fff3cd;
      color: #856404;
    }
    .status-pill--approved {
      background: #d4edda;
      color: #155724;
    }
    .status-pill--rejected {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>

<body class="page">

<header class="site-header">
  <div class="header-inner">
    <div class="logo">BrickBook</div>
    <nav class="nav">
      <a href="contractor-dashboard.html">Dashboard</a>
      <a href="pricing-table.html">Pricing</a>
      <a href="approvals.html">Approvals</a>
      <a href="contractor-review.html" class="active">Review</a>
      <a href="#" onclick="logout(event)">Logout</a>
    </nav>
  </div>
</header>

<main class="container" style="padding-top:20px;">

  <h1 class="h1">Submission Review</h1>
  <p class="text-muted">Review full booking-off submission and approve or reject.</p>

  <div id="loading">Loading submission...</div>
  <div id="content" style="display:none;">

    <!-- SUMMARY -->
    <section class="card" style="margin-top:20px;">
      <div class="section-title">Submission Summary</div>
      <div><strong>Squad:</strong> <span id="summary-squad"></span></div>
      <div><strong>Site:</strong> <span id="summary-site"></span></div>
      <div><strong>Submitted:</strong> <span id="summary-date"></span></div>
      <div><strong>Status:</strong> 
        <span id="summary-status" class="status-pill"></span>
      </div>
    </section>

    <!-- PLOTS -->
    <section class="card" style="margin-top:20px;">
      <div class="section-title">Plots</div>
      <div id="plots-area"></div>
    </section>

    <!-- SPLIT -->
    <section class="card" style="margin-top:20px;">
      <div class="section-title">Squad Split</div>
      <div id="split-area" class="text-muted">No split submitted.</div>
    </section>

    <!-- TOTALS -->
    <section class="card" style="margin-top:20px;">
      <div class="section-title">Totals</div>
      <div class="grand-total-box">
        Labour Total: £<span id="grand-total">0.00</span>
      </div>
    </section>

    <!-- ACTION BUTTONS -->
    <section class="card" style="margin-top:20px;">
      <button class="btn btn-primary" style="margin-right:10px;" onclick="approve()">Approve</button>
      <button class="btn btn-danger" onclick="reject()">Reject</button>
    </section>

  </div>

</main>

<footer class="site-footer">
  <div class="footer-inner">© 2025 BrickBook</div>
</footer>

<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    doc,
    getDoc,
    updateDoc
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const params = new URLSearchParams(window.location.search);
  const submissionId = params.get("id");

  let contractorId = null;

  // Protect page
  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      window.location.href = "contractor-login.html";
      return;
    }
    contractorId = user.uid;
    loadSubmission();
  });

  async function loadSubmission() {
    const ref = doc(db, `contractors/${contractorId}/submissions/${submissionId}`);
    const snap = await getDoc(ref);

    if (!snap.exists()) {
      document.getElementById("loading").innerText = "Submission not found.";
      return;
    }

    const data = snap.data();

    // Fill summary
    document.getElementById("summary-squad").textContent = data.squad;
    document.getElementById("summary-site").textContent = data.site;
    document.getElementById("summary-date").textContent = data.submittedAt?.toDate().toLocaleString() || "—";

    const statusEl = document.getElementById("summary-status");
    statusEl.textContent = data.status;
    statusEl.classList.add("status-pill--" + data.status);

    // Fill plots
    const plotsArea = document.getElementById("plots-area");
    plotsArea.innerHTML = "";

    data.plots.forEach(plot => {
      const div = document.createElement("div");
      div.className = "plot-card";
      div.innerHTML = `
        <div class="plot-head">Plot ${plot.plot}</div>
        ${plot.rows.map(r => `
          <div class="labour-row">
            <span>${r.measurement}</span>
            <span>${r.qty} × £${r.rate}</span>
          </div>
        `).join("")}
        <div class="text-muted" style="margin-top:6px;">Notes: ${plot.notes || "—"}</div>
      `;
      plotsArea.appendChild(div);
    });

    // Split
    const splitArea = document.getElementById("split-area");
    if (data.split?.length) {
      splitArea.innerHTML = data.split.map(s => `
        <div>${s.name}: ${s.percent}%</div>
      `).join("");
    }

    // Totals
    document.getElementById("grand-total").textContent = data.grandTotal?.toFixed(2) || "0.00";

    document.getElementById("loading").style.display = "none";
    document.getElementById("content").style.display = "block";
  }

  // Approve / Reject
  window.approve = async function () {
    const ref = doc(db, `contractors/${contractorId}/submissions/${submissionId}`);
    await updateDoc(ref, { status: "approved" });
    alert("Submission approved.");
    window.location.href = "approvals.html";
  };

  window.reject = async function () {
    const ref = doc(db, `contractors/${contractorId}/submissions/${submissionId}`);
    await updateDoc(ref, { status: "rejected" });
    alert("Submission rejected.");
    window.location.href = "approvals.html";
  };

  window.logout = async function (e) {
    if (e) e.preventDefault();
    await signOut(auth);
    window.location.href = "contractor-login.html";
  };
</script>

</body>
</html>
