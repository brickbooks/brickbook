<!-- FIREBASE APPROVALS LOGIC -->
<script type="module">
  import { auth, db } from "./firebase.js";
  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    collection,
    onSnapshot,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  let submissions = [];      // will be filled with Firestore data
  let activeFilter = "all";
  let searchQuery = "";

  const tbody = document.getElementById("approvalsBody");
  const emptyState = document.getElementById("emptyState");

  function logout() {
    signOut(auth);
  }

  // Render table
  function loadTable() {
    tbody.innerHTML = "";

    const q = searchQuery.trim().toLowerCase();

    const filtered = submissions.filter(s => {
      // status filter
      if (activeFilter !== "all" && s.status !== activeFilter) return false;

      // search text
      if (!q) return true;

      const haystack = [
        s.date,
        s.squad,
        String(s.plots),
        String(s.total),
        s.status
      ].join(" ").toLowerCase();

      return haystack.includes(q);
    });

    if (!filtered.length) {
      emptyState.style.display = "block";
      return;
    } else {
      emptyState.style.display = "none";
    }

    filtered.forEach(s => {
      const row = document.createElement("tr");

      const classMap = {
        pending: "status-pill status-pill--pending",
        approved: "status-pill status-pill--approved",
        rejected: "status-pill status-pill--rejected"
      };

      row.innerHTML = `
        <td>${s.date}</td>
        <td>${s.squad}</td>
        <td>${s.plots}</td>
        <td>£${parseFloat(s.total).toFixed(2)}</td>
        <td><span class="${classMap[s.status]}">${s.status}</span></td>
        <td><a class="btn btn-primary btn-sm" href="contractor-review-squad.html?id=${s.id}">View</a></td>
      `;
      tbody.appendChild(row);
    });
  }

  // Apply filter buttons
  window.setFilter = function (filter, btn) {
    activeFilter = filter;

    document.querySelectorAll(".status-chip").forEach(b => {
      b.classList.toggle("active", b === btn);
    });

    loadTable();
  };

  // Search bar
  document.getElementById("search-input").addEventListener("input", (e) => {
    searchQuery = e.target.value;
    loadTable();
  });

  // AUTH + FIRESTORE LOADING
  onAuthStateChanged(auth, user => {
    if (!user) {
      window.location.href = "contractor-login.html";
      return;
    }

    const submissionsRef = collection(db, `contractors/${user.uid}/submissions`);

    // Live updates & newest first
    const q = query(submissionsRef, orderBy("submission_date", "desc"));

    onSnapshot(q, snap => {
      submissions = snap.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          date: data.submission_date || "—",
          squad: data.squad || "—",
          plots: data.plots || 0,
          total: data.total_price || 0,
          status: data.status || "pending"
        };
      });

      loadTable();
    });
  });
</script>
