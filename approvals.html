<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Approvals – BrickBook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/style.css" />
  <script type="module" src="./firebase.js"></script>

  <style>
    /* Page-specific enhancements */

    .approvals-hero {
      background: linear-gradient(
        135deg,
        rgba(27,115,232,0.18),
        rgba(27,115,232,0.04)
      );
      border-radius: 20px;
      padding: 28px 22px;
      box-shadow: var(--shadow-soft);
      margin-top: 24px;
      margin-bottom: 22px;
      text-align: center;
    }

    .filters-card {
      margin-bottom: 22px;
    }

    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }

    .filters-row .search-wrap {
      flex: 1 1 220px;
      min-width: 0;
    }

    .filters-row .status-filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }

    .status-chip {
      padding: 7px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      background: #ffffff;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.2s ease;
    }

    .status-chip.active {
      background: var(--blue);
      color: #ffffff;
      border-color: var(--blue);
    }

    .empty-state {
      text-align: center;
      padding: 20px 10px;
      font-size: 14px;
      color: var(--text-muted);
    }

    @media (max-width: 640px) {
      .filters-row {
        align-items: stretch;
      }
    }
  </style>
</head>

<body class="page" data-page="approvals">

<!-- HEADER -->
<header class="site-header">
  <div class="header-inner">
    <div class="logo">BrickBook</div>
    <nav class="nav">
      <a href="contractor-dashboard.html">Dashboard</a>
      <a href="pricing-table.html">Pricing</a>
      <a href="approvals.html" class="active">Approvals</a>
      <a href="contractor-review.html">Review</a>
      <a href="#" onclick="logout(event)">Logout</a>
    </nav>
    <div class="hamburger" onclick="toggleMenu()">☰</div>
  </div>
</header>

<!-- MOBILE MENU -->
<div id="mobileMenu" class="mobile-nav">
  <a href="contractor-dashboard.html">Dashboard</a>
  <a href="pricing-table.html">Pricing</a>
  <a href="approvals.html">Approvals</a>
  <a href="contractor-review.html">Review</a>
  <a href="#" onclick="logout(event)">Logout</a>
</div>

<main class="container">

  <!-- HERO -->
  <section class="approvals-hero">
    <h1 class="h1" style="font-size:30px;">Booking-Off Approvals</h1>
    <p class="text-muted" style="font-size:15px;">
      Filter, review and action squad submissions in one place.
    </p>
  </section>

  <!-- FILTER BAR -->
  <section class="card filters-card">
    <div class="filters-row">
      <div class="search-wrap">
        <label for="search-input">Search</label>
        <input
          id="search-input"
          type="text"
          placeholder="Search by squad, date, status, plots or total..."
        />
      </div>

      <div class="status-filters">
        <button class="status-chip active" onclick="setFilter('all', this)">All</button>
        <button class="status-chip" onclick="setFilter('pending', this)">Pending</button>
        <button class="status-chip" onclick="setFilter('approved', this)">Approved</button>
        <button class="status-chip" onclick="setFilter('rejected', this)">Rejected</button>
      </div>
    </div>
  </section>

  <!-- SUBMISSIONS TABLE -->
  <section class="card">
    <div class="card-header-row">
      <div>
        <div class="card-title">Submissions</div>
        <div class="card-sub">Newest first. Use filters above to narrow results.</div>
      </div>
    </div>

    <table class="table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>Date</th>
          <th>Squad</th>
          <th>Plots</th>
          <th>Total (£)</th>
          <th>Status</th>
          <th>View</th>
        </tr>
      </thead>
      <tbody id="approvalsBody"></tbody>
    </table>

    <div id="emptyState" class="empty-state" style="display:none;">
      No submissions found. Try changing the filter or clearing the search.
    </div>
  </section>

</main>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-inner">
    <span>© 2025 BrickBook</span>
    <span class="text-muted">Approvals</span>
  </div>
</footer>

<script src="assets/main.js"></script>

<!-- FIREBASE LOGIC -->
<script type="module">
  import { auth, db } from "./firebase.js";

  import {
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  import {
    collection,
    onSnapshot,
    query,
    orderBy
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";


  /* ---------------------------
      GLOBAL STATE
  ----------------------------*/
  let submissions = []; 
  let activeFilter = "all";
  let searchQuery = "";


  /* ---------------------------
      LOGOUT HANDLER
  ----------------------------*/
  window.logout = async function (e) {
    if (e) e.preventDefault();
    await signOut(auth);
    window.location.href = "contractor-login.html";
  };


  /* ---------------------------
      RENDER TABLE
  ----------------------------*/
  const tbody = document.getElementById("approvalsBody");
  const emptyState = document.getElementById("emptyState");

  function loadTable() {
    tbody.innerHTML = "";

    const q = searchQuery.toLowerCase().trim();

    const filtered = submissions.filter(s => {
      // Filter by status
      if (activeFilter !== "all" && s.status !== activeFilter) return false;

      // Search filter
      if (q) {
        const haystack = [
          s.date,
          s.squad,
          String(s.plots),
          String(s.total),
          s.status
        ].join(" ").toLowerCase();

        if (!haystack.includes(q)) return false;
      }

      return true;
    });

    if (!filtered.length) {
      emptyState.style.display = "block";
      return;
    } else {
      emptyState.style.display = "none";
    }

    filtered.forEach(s => {
      const row = document.createElement("tr");

      const classMap = {
        pending: "status-pill status-pill--pending",
        approved: "status-pill status-pill--approved",
        rejected: "status-pill status-pill--rejected"
      };

      row.innerHTML = `
        <td>${s.date}</td>
        <td>${s.squad}</td>
        <td>${s.plots}</td>
        <td>£${parseFloat(s.total).toFixed(2)}</td>
        <td><span class="${classMap[s.status]}">${s.status}</span></td>
        <td>
          <a class="btn btn-primary btn-sm" href="contractor-review-squad.html?id=${s.id}">
            View
          </a>
        </td>
      `;

      tbody.appendChild(row);
    });
  }


  /* ---------------------------
      FILTER BUTTONS
  ----------------------------*/
  window.setFilter = function (filter, btn) {
    activeFilter = filter;

    document.querySelectorAll(".status-chip")
      .forEach(b => b.classList.toggle("active", b === btn));

    loadTable();
  };

  document.getElementById("search-input").addEventListener("input", (e) => {
    searchQuery = e.target.value;
    loadTable();
  });


  /* ---------------------------
      AUTH + FIRESTORE LISTENER
  ----------------------------*/
  onAuthStateChanged(auth, (user) => {
    if (!user) {
      window.location.href = "contractor-login.html";
      return;
    }

    const submissionsRef = collection(db, `contractors/${user.uid}/submissions`);

    const q = query(submissionsRef, orderBy("submission_date", "desc"));

    // Live updates from Firestore
    onSnapshot(q, (snap) => {
      submissions = snap.docs.map(doc => {
        const d = doc.data();
        return {
          id: doc.id,
          date: d.submission_date || "—",
          squad: d.squad || "—",
          plots: d.plots || 0,
          total: d.total_price || 0,
          status: d.status || "pending"
        };
      });

      loadTable();
    });
  });

</script>

<script>
function toggleMenu() {
  document.getElementById('mobileMenu').classList.toggle('show');
}
</script>

</body>
</html>
