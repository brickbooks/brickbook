<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Contractor Dashboard ‚Äì BrickBook</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="assets/style.css" />

  <!-- Load Firebase -->
  <script type="module" src="./firebase.js"></script>

  <style>
    .dashboard-hero {
      background: linear-gradient(
        135deg,
        rgba(27, 115, 232, 0.18),
        rgba(27, 115, 232, 0.04)
      );
      border-radius: 20px;
      padding: 32px 22px;
      box-shadow: var(--shadow-soft);
      margin-top: 24px;
      margin-bottom: 24px;
      text-align: center;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 14px;
      margin-bottom: 24px;
    }

    .action-btn {
      display: block;
      padding: 14px 18px;
      background: var(--card-bg);
      border-radius: 14px;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--border-subtle);
      box-shadow: var(--shadow-soft);
      text-decoration: none;
      color: var(--text-main);
      transition: 0.2s ease;
    }
    .action-btn:hover {
      border-color: var(--blue);
      color: var(--blue);
    }

    .status-pill {
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.4px;
    }
  </style>
</head>

<body class="page" data-page="dashboard">

<!-- Load today‚Äôs submissions from Firestore -->
<script type="module">
  import { db, auth } from "./firebase.js";
  import {
    collection,
    onSnapshot,
    query,
    where
  } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const tbody = document.getElementById("booking-table-body");

  function renderStatus(status) {
    const classMap = {
      pending: "status-pill status-pill--pending",
      approved: "status-pill status-pill--approved",
      rejected: "status-pill status-pill--rejected"
    };
    return `<span class="${classMap[status] || classMap.pending}">${status}</span>`;
  }

  function loadTodaysBookings(contractorId) {
    // Get today's date (yyyy-mm-dd)
    const today = new Date().toISOString().split("T")[0];

    // Query submissions where submission_date == today
    const submissionsRef = collection(
      db,
      `contractors/${contractorId}/submissions`
    );

    const q = query(submissionsRef, where("submission_date", "==", today));

    onSnapshot(q, (snap) => {
      tbody.innerHTML = ""; // clear table

      if (snap.empty) {
        tbody.innerHTML = `
          <tr><td colspan="6" style="text-align:center; color:#777;">
            No bookings submitted yet today.
          </td></tr>`;
        return;
      }

      snap.forEach((doc) => {
        const b = doc.data();
        const row = document.createElement("tr");

        row.innerHTML = `
          <td>${b.squad || "‚Äî"}</td>
          <td>${b.plots || 0}</td>
          <td>¬£${(b.total_price || 0).toFixed(2)}</td>
          <td>${b.time || "‚Äî"}</td>
          <td>${renderStatus(b.status || "pending")}</td>
          <td><a class="btn btn-primary btn-sm" href="approvals.html?id=${doc.id}">View</a></td>
        `;

        tbody.appendChild(row);
      });
    });
  }

  // Wait for Firebase Auth ‚Üí then load today's bookings
  import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

  onAuthStateChanged(auth, (user) => {
    if (user) {
      loadTodaysBookings(user.uid);
    }
  });
</script>

<script>
function toggleMenu() {
  document.getElementById('mobileMenu').classList.toggle('show');
}
</script>


<!-- HEADER -->
<header class="site-header">
  <div class="header-inner">
    <div class="logo">BrickBook</div>
    <nav class="nav">
      <a href="contractor-dashboard.html" class="active">Dashboard</a>
      <a href="pricing-table.html">Pricing</a>
      <a href="approvals.html">Approvals</a>
      <a href="contractor-review.html">Review</a>
      <a href="contractor-add-squads.html">Add Squads</a>
      <a href="#" onclick="logout(event)">Logout</a>
    </nav>
    <div class="hamburger" onclick="toggleMenu()">‚ò∞</div>
  </div>
</header>

<!-- MOBILE MENU -->
<div id="mobileMenu" class="mobile-nav">
  <a href="contractor-dashboard.html">Dashboard</a>
  <a href="pricing-table.html">Pricing</a>
  <a href="approvals.html">Approvals</a>
  <a href="contractor-review.html">Review</a>
  <a href="contractor-add-squads.html">Add Squads</a>
  <a href="#" onclick="logout(event)">Logout</a>
</div>

<main class="container">

  <!-- PAGE HERO with dynamic Firebase profile -->
  <section class="dashboard-hero">
    <h1 class="h1" style="font-size:32px;">Welcome, <span id="contractorName">Loading...</span></h1>
    <p class="text-muted" style="font-size:16px;">
      Company: <strong id="companyName">Loading...</strong><br>
      Review booking submissions, manage squads & pricing.
    </p>
  </section>

  <!-- QUICK ACTION BUTTONS -->
  <section class="quick-actions">
    <a href="pricing-table.html" class="action-btn">üí∑ Pricing Table</a>
    <a href="approvals.html" class="action-btn">üìù Pending Approvals</a>
    <a href="contractor-review.html" class="action-btn">üìä Review All Entries</a>
    <a href="contractor-add-squads.html" class="action-btn">üë∑ Add Squads</a>
  </section>

  <!-- TODAY'S BOOKINGS CARD -->
  <section class="card">
    <div class="card-header-row">
      <div>
        <div class="card-title">Today's Booking-Offs</div>
        <div class="card-sub">Live submissions received today.</div>
      </div>
    </div>

    <table class="table" style="margin-top:10px;">
      <thead>
        <tr>
          <th>Squad</th>
          <th>Plots</th>
          <th>Total (¬£)</th>
          <th>Time</th>
          <th>Status</th>
          <th>View</th>
        </tr>
      </thead>
      <tbody id="booking-table-body"></tbody>
    </table>
  </section>

</main>

<!-- FOOTER -->
<footer class="site-footer">
  <div class="footer-inner">
    <span>¬© 2025 BrickBook</span>
    <span class="text-muted">Contractor Dashboard</span>
  </div>
</footer>

<script src="assets/main.js"></script>

<script>
  const demoBookings = [
    { squad: "Team A", plots: 3, total: 1400, time: "08:45", status: "pending" },
    { squad: "Team B", plots: 1, total: 460, time: "10:12", status: "approved" }
  ];

  function loadBookings() {
    let tbody = document.getElementById("booking-table-body");

    demoBookings.forEach(b => {
      const statusColours = {
        pending: "status-pill status-pill--pending",
        approved: "status-pill status-pill--approved",
        rejected: "status-pill status-pill--rejected"
      };

      let row = document.createElement("tr");
      row.innerHTML = `
        <td>${b.squad}</td>
        <td>${b.plots}</td>
        <td>¬£${b.total.toFixed(2)}</td>
        <td>${b.time}</td>
        <td><span class="${statusColours[b.status]}">${b.status}</span></td>
        <td><a class="btn btn-primary btn-sm" href="approvals.html">View</a></td>
      `;
      tbody.appendChild(row);
    });
  }

  loadBookings();
</script>

<script>
function toggleMenu() {
  document.getElementById('mobileMenu').classList.toggle('show');
}
</script>

</body>
</html>
